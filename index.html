<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nova</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0e1a;
      --bg-gradient: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%);
      --panel: #131729;
      --panel2: #0f1424;
      --text: #f0f4ff;
      --muted: #8b9dc3;
      --border: rgba(139, 157, 195, 0.15);
      --hover: rgba(91, 141, 239, 0.1);
      --active: rgba(91, 141, 239, 0.2);
      --accent: #5b8def;
      --accent-glow: rgba(91, 141, 239, 0.4);
      --online: #00ff88;
      --offline: #555;
      --alert: #ff4444;
      --success: #00ff88;
      --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --coin-gold: #ffd700;
    }

    body.light-mode {
      --bg: #f5f7fa;
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      --panel: #ffffff;
      --panel2: #f8f9fb;
      --text: #1a1f36;
      --muted: #4a5568;
      --border: rgba(74, 85, 104, 0.2);
      --hover: rgba(91, 141, 239, 0.1);
      --active: rgba(91, 141, 239, 0.15);
      --accent: #3b7dd8;
      --accent-glow: rgba(59, 125, 216, 0.4);
      --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      position: relative;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.performance-mode .bg-container * { animation: none !important; transition: none !important; }
    body.performance-mode .particle,
    body.performance-mode .orb,
    body.performance-mode .gradient-wave,
    body.performance-mode .scanline { display: none !important; }

    .bg-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      overflow: hidden; z-index: 0; pointer-events: none; transition: opacity 0.5s ease;
    }

    .custom-bg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover; background-position: center; background-repeat: no-repeat;
      display: none; z-index: 1;
    }
    .custom-bg.active { display: block; }

    .gradient-wave {
      position: absolute; width: 200%; height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(91, 141, 239, 0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 40% 20%, rgba(147, 51, 234, 0.1) 0%, transparent 50%);
      animation: waveMove 20s ease-in-out infinite;
    }
    @keyframes waveMove {
      0%, 100% { transform: translate(-25%, -25%) rotate(0deg); opacity: 0.6; }
      33% { transform: translate(-30%, -20%) rotate(120deg); opacity: 0.8; }
      66% { transform: translate(-20%, -30%) rotate(240deg); opacity: 0.7; }
    }

    .orb {
      position: absolute; border-radius: 50%; filter: blur(40px);
      animation: floatOrb 15s ease-in-out infinite; opacity: 0.3;
    }
    .orb-1 { width: 400px; height: 400px; background: linear-gradient(135deg, rgba(91, 141, 239, 0.4), rgba(147, 51, 234, 0.3)); top: 10%; left: 10%; animation-delay: 0s; animation-duration: 25s; }
    .orb-2 { width: 500px; height: 500px; background: linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(91, 141, 239, 0.3)); bottom: 10%; right: 10%; animation-delay: -8s; animation-duration: 30s; }
    .orb-3 { width: 300px; height: 300px; background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(0, 255, 136, 0.2)); top: 50%; left: 50%; animation-delay: -15s; animation-duration: 22s; }
    @keyframes floatOrb {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(150px, -150px) scale(1.2) rotate(90deg); }
      50% { transform: translate(-150px, 150px) scale(0.9) rotate(180deg); }
      75% { transform: translate(100px, 100px) scale(1.1) rotate(270deg); }
    }

    .particles { position: absolute; width: 100%; height: 100%; }
    .particle {
      position: absolute; width: 3px; height: 3px; background: rgba(91, 141, 239, 0.6);
      border-radius: 50%; box-shadow: 0 0 10px rgba(91, 141, 239, 0.8);
      animation: particleFloat linear infinite;
    }
    @keyframes particleFloat {
      0% { transform: translateY(100vh) translateX(0) scale(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) translateX(var(--drift)) scale(1); opacity: 0; }
    }

    .grid-overlay {
      position: absolute; width: 100%; height: 100%;
      background-image: 
        linear-gradient(rgba(91, 141, 239, 0.05) 2px, transparent 2px),
        linear-gradient(90deg, rgba(91, 141, 239, 0.05) 2px, transparent 2px),
        linear-gradient(rgba(91, 141, 239, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(91, 141, 239, 0.02) 1px, transparent 1px);
      background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
      animation: gridPulse 8s ease-in-out infinite;
    }
    @keyframes gridPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    .scanline {
      position: absolute; width: 100%; height: 3px;
      background: linear-gradient(90deg, transparent 0%, rgba(91, 141, 239, 0.5) 50%, transparent 100%);
      animation: scanlineMove 4s linear infinite;
      box-shadow: 0 0 15px rgba(91, 141, 239, 0.7);
    }
    @keyframes scanlineMove { 0% { top: -3px; } 100% { top: 100%; } }

    .energy-ring {
      position: absolute; top: 50%; left: 50%; width: 100px; height: 100px;
      border: 2px solid rgba(91, 141, 239, 0.3); border-radius: 50%;
      animation: energyExpand 6s ease-out infinite;
    }
    .energy-ring:nth-child(2) { animation-delay: 2s; }
    .energy-ring:nth-child(3) { animation-delay: 4s; }
    @keyframes energyExpand {
      0% { width: 100px; height: 100px; opacity: 1; transform: translate(-50%, -50%); }
      100% { width: 1000px; height: 1000px; opacity: 0; transform: translate(-50%, -50%); }
    }

    .app {
      display: grid;
      grid-template-rows: 64px 1fr;
      grid-template-columns: 280px 1fr;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    body.grid-mode .scroller {
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    body.grid-mode .game,
    body.grid-mode .movie,
    body.grid-mode .tvshow,
    body.grid-mode .shop-item { width: 100%; }

    header {
      grid-column: 1/-1;
      display: flex; align-items: center; padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(19, 23, 41, 0.8);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
      gap: 20px;
    }
    body.light-mode header { background: rgba(255, 255, 255, 0.9); }

    .brand {
      font-weight: 800; font-size: 22px; letter-spacing: -0.5px;
      background: linear-gradient(135deg, #5b8def 0%, #00ff88 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      animation: brandGlow 3s ease-in-out infinite;
    }
    @keyframes brandGlow {
      0%, 100% { filter: drop-shadow(0 0 8px rgba(91, 141, 239, 0.4)); }
      50% { filter: drop-shadow(0 0 16px rgba(91, 141, 239, 0.6)); }
    }

    .header-info { margin-left: auto; display: flex; align-items: center; gap: 16px; font-size: 13px; font-weight: 600; }
    .info-item { display: flex; flex-direction: column; align-items: flex-start; padding: 6px 12px; background: rgba(91, 141, 239, 0.1); border: 1px solid var(--border); border-radius: 8px; min-width: 100px; }
    .info-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 2px; }
    .info-value { font-size: 13px; font-weight: 700; color: var(--text); }
    #current-time { font-family: 'Courier New', monospace; letter-spacing: 0.05em; }

    .coin-display {
      display: flex; align-items: center; gap: 8px; padding: 8px 16px;
      background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.3s ease;
    }
    .coin-display:hover { background: rgba(255, 215, 0, 0.2); box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3); }
    .coin-icon {
      width: 24px; height: 24px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 14px; box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }

    aside {
      border-right: 1px solid var(--border);
      background: rgba(19, 23, 41, 0.6);
      backdrop-filter: blur(20px);
      padding: 20px;
      overflow-y: auto;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.2);
    }
    body.light-mode aside { background: rgba(255, 255, 255, 0.8); }
    aside::-webkit-scrollbar { width: 6px; }
    aside::-webkit-scrollbar-track { background: transparent; }
    aside::-webkit-scrollbar-thumb { background: rgba(91, 141, 239, 0.3); border-radius: 3px; }

    .nav-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); margin: 6px 12px 12px; font-weight: 700; }
    .nav { display: flex; flex-direction: column; gap: 8px; }
    .nav a {
      display: flex; align-items: center; gap: 12px; text-decoration: none;
      color: var(--text); padding: 12px 14px; border-radius: 12px;
      border: 1px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer; position: relative; overflow: hidden; font-weight: 500;
    }
    .nav a::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      border-radius: 50%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      transform: translate(-50%, -50%); transition: width 0.6s ease, height 0.6s ease;
    }
    .nav a:hover::before { width: 300px; height: 300px; }
    .nav a:hover { background: var(--hover); border-color: var(--accent); transform: translateX(4px); box-shadow: 0 4px 16px rgba(91, 141, 239, 0.2); }
    .nav a.active { background: var(--active); border-color: var(--accent); box-shadow: 0 4px 16px rgba(91, 141, 239, 0.3); }

    .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--accent); flex: 0 0 auto; box-shadow: 0 0 8px var(--accent-glow); animation: dotPulse 2s ease-in-out infinite; }
    @keyframes dotPulse { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.2); opacity: 1; } }

    main { overflow: hidden; display: flex; flex-direction: column; position: relative; }
    .page-section { display: none; padding: 24px; overflow-y: auto; height: 100%; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .page-section::-webkit-scrollbar { width: 8px; }
    .page-section::-webkit-scrollbar-track { background: transparent; }
    .page-section::-webkit-scrollbar-thumb { background: rgba(91, 141, 239, 0.3); border-radius: 4px; }
    .page-section.active { display: block; }

    .card {
      max-width: 100%;
      background: rgba(19, 23, 41, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      margin-bottom: 24px;
    }
    body.light-mode .card { background: rgba(255, 255, 255, 0.8); }
    .card:hover { border-color: rgba(91, 141, 239, 0.3); box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6), 0 0 32px rgba(91, 141, 239, 0.1); }
    .card h1 { margin: 0 0 12px; font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .card h2 { margin: 0 0 12px; font-size: 22px; font-weight: 700; color: var(--text); }
    .card p { margin: 0 0 18px; color: var(--muted); line-height: 1.6; font-size: 15px; }

    .actions { margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; }
    .btn {
      appearance: none; border: 1px solid var(--border); background: rgba(91, 141, 239, 0.1);
      color: var(--text); padding: 12px 20px; border-radius: 12px; font-weight: 700;
      text-decoration: none; display: inline-block; cursor: pointer; font-size: 13px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; letter-spacing: 0.3px;
    }
    .btn::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      border-radius: 50%; background: radial-gradient(circle, rgba(91, 141, 239, 0.4) 0%, transparent 70%);
      transform: translate(-50%, -50%); transition: width 0.6s ease, height 0.6s ease;
    }
    .btn:hover::before { width: 300px; height: 300px; }
    .btn:hover { background: rgba(91, 141, 239, 0.2); border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(91, 141, 239, 0.3), 0 0 40px rgba(91, 141, 239, 0.2); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .settings-container { max-width: 800px; }
    .settings-group { margin-bottom: 32px; }
    .settings-group h2 { font-size: 20px; margin-bottom: 16px; color: var(--accent); display: flex; align-items: center; gap: 10px; }
    .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: rgba(91, 141, 239, 0.05); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; transition: all 0.3s ease; }
    .setting-item:hover { border-color: var(--accent); background: rgba(91, 141, 239, 0.1); }
    .setting-info { flex: 1; }
    .setting-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .setting-desc { font-size: 13px; color: var(--muted); }

    .toggle-switch { position: relative; width: 54px; height: 28px; background: rgba(91, 141, 239, 0.2); border-radius: 14px; cursor: pointer; transition: all 0.3s ease; border: 2px solid var(--border); }
    .toggle-switch.active { background: var(--accent); border-color: var(--accent); }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    .toggle-switch.active::after { left: 28px; }

    .file-input-wrapper { position: relative; display: inline-block; }
    .file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .file-input-label { display: inline-block; padding: 12px 20px; background: rgba(91, 141, 239, 0.15); border: 1px solid var(--accent); border-radius: 12px; cursor: pointer; font-weight: 700; transition: all 0.3s ease; }
    .file-input-label:hover { background: rgba(91, 141, 239, 0.3); box-shadow: 0 4px 16px rgba(91, 141, 239, 0.3); }

    .search-wrap { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .search-input, .clear-btn { padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border); background: rgba(91, 141, 239, 0.05); color: var(--text); font-weight: 600; transition: all 0.3s ease; }
    .search-input { min-width: 220px; flex: 1; }
    .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 20px rgba(91, 141, 239, 0.2); background: rgba(91, 141, 239, 0.1); }
    .clear-btn { cursor: pointer; font-weight: 800; transition: all 0.3s ease; }
    .clear-btn:hover { background: rgba(255, 68, 68, 0.2); border-color: var(--alert); box-shadow: 0 4px 16px rgba(255, 68, 68, 0.3); }

    .row { margin-top: 24px; }
    .row-title { font-size: 13px; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-weight: 700; }

    .scroller { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 12px; -webkit-overflow-scrolling: touch; }
    .scroller::-webkit-scrollbar { height: 6px; }
    .scroller::-webkit-scrollbar-track { background: rgba(91, 141, 239, 0.05); border-radius: 3px; }
    .scroller::-webkit-scrollbar-thumb { background: rgba(91, 141, 239, 0.3); border-radius: 3px; }

    .game, .movie, .tvshow, .shop-item {
      width: 260px; background: rgba(19, 23, 41, 0.6); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 18px; padding: 16px;
      display: flex; flex-direction: column; gap: 12px; flex: 0 0 auto;
      transition: all 0.3s ease; cursor: pointer; position: relative;
    }
    body.light-mode .game, body.light-mode .movie, body.light-mode .tvshow, body.light-mode .shop-item { background: rgba(255, 255, 255, 0.8); }
    .game:hover, .movie:hover, .tvshow:hover, .shop-item:hover { transform: translateY(-8px) scale(1.02); border-color: var(--accent); box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 40px rgba(91, 141, 239, 0.2); }

    .favorite-btn { position: absolute; top: 24px; right: 24px; background: rgba(19, 23, 41, 0.8); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10; transition: all 0.3s ease; }
    .favorite-btn:hover { transform: scale(1.1); box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4); }
    .favorite-btn.active { background: rgba(255, 215, 0, 0.2); border-color: var(--coin-gold); }

    .thumb { height: 180px; object-fit: contain; background: rgba(0, 0, 0, 0.3); border-radius: 14px; border: 1px solid var(--border); transition: all 0.3s ease; }
    .game:hover .thumb, .movie:hover .thumb, .tvshow:hover .thumb, .shop-item:hover .thumb { box-shadow: 0 8px 24px rgba(91, 141, 239, 0.3); }
    .game strong, .movie strong, .tvshow strong, .shop-item strong { font-size: 15px; font-weight: 700; }
    .shop-item .price { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 800; color: var(--coin-gold); }
    .shop-item .price .coin-icon { width: 20px; height: 20px; font-size: 12px; }

    .game-btn, .movie-btn, .tvshow-btn, .buy-btn { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(91, 141, 239, 0.15); font-weight: 800; cursor: pointer; color: #ffffff; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .buy-btn { background: rgba(255, 215, 0, 0.15); border-color: rgba(255, 215, 0, 0.3); }
    .buy-btn:hover { background: rgba(255, 215, 0, 0.3); border-color: var(--coin-gold); box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); }
    .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .game-btn:hover, .movie-btn:hover, .tvshow-btn:hover { background: rgba(91, 141, 239, 0.3); border-color: var(--accent); box-shadow: 0 4px 20px rgba(91, 141, 239, 0.4); transform: translateY(-2px); }
    .empty { margin: 0; color: var(--muted); font-weight: 700; font-size: 14px; }

    .notification { position: fixed; bottom: 20px; right: 20px; background: rgba(19, 23, 41, 0.95); backdrop-filter: blur(20px); border: 2px solid var(--accent); border-radius: 16px; padding: 16px 24px; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 32px rgba(91, 141, 239, 0.3); transform: translateX(150%); transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; max-width: 400px; }
    .notification.show { transform: translateX(0); }
    .notification.success { border-color: var(--success); }
    .notification.warning { border-color: #ffaa00; }
    .notification.error { border-color: var(--alert); }
    .notification-icon { font-size: 24px; }
    .notification-text { font-weight: 700; font-size: 14px; color: var(--text); }

    /* BADGE SYSTEM */
    .badge-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 16px; margin-top: 16px; }
    .badge { background: rgba(19, 23, 41, 0.6); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 14px; padding: 16px; text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative; }
    .badge.unlocked { border-color: var(--coin-gold); box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3); }
    .badge.locked { opacity: 0.4; filter: grayscale(100%); }
    .badge.code-required { border-style: dashed; }
    .badge:hover { transform: translateY(-4px); }
    .badge-icon { font-size: 48px; margin-bottom: 8px; }
    .badge-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
    .badge-desc { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
    .badge-tag { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; display: inline-block; }
    .badge-tag.auto { background: rgba(0,255,136,0.15); color: var(--success); border: 1px solid rgba(0,255,136,0.3); }
    .badge-tag.code { background: rgba(255,215,0,0.15); color: var(--coin-gold); border: 1px solid rgba(255,215,0,0.3); }
    .badge-tag.earned { background: rgba(91,141,239,0.15); color: var(--accent); border: 1px solid rgba(91,141,239,0.3); }
    .badge-code-area { margin-top: 10px; display: none; flex-direction: column; gap: 8px; }
    .badge-code-area.show { display: flex; }
    .badge-code-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: rgba(91,141,239,0.05); color: var(--text); font-size: 13px; font-weight: 600; outline: none; transition: all 0.3s ease; }
    .badge-code-input:focus { border-color: var(--accent); background: rgba(91,141,239,0.1); }
    .badge-code-submit { padding: 7px 12px; border-radius: 8px; border: 1px solid var(--accent); background: rgba(91,141,239,0.15); color: var(--text); font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
    .badge-code-submit:hover { background: rgba(91,141,239,0.3); }

    .status-update { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(91, 141, 239, 0.05); border: 1px solid var(--border); border-radius: 12px; }
    .status-input { flex: 1; background: transparent; border: none; color: var(--text); outline: none; font-weight: 500; }

    .shortcut-key { display: inline-block; padding: 4px 8px; background: rgba(91, 141, 239, 0.1); border: 1px solid var(--border); border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; font-weight: 700; margin: 0 4px; }
    .shortcut-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(91, 141, 239, 0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
    .shortcut-action { font-weight: 600; }
    .shortcut-keys { display: flex; gap: 4px; }

    .category-filter { display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap; }
    .category-btn { padding: 8px 16px; background: rgba(91, 141, 239, 0.1); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; }
    .category-btn:hover { background: rgba(91, 141, 239, 0.2); border-color: var(--accent); }
    .category-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.3s ease; }
    .modal.show { display: flex; }
    .modal-content { background: rgba(19, 23, 41, 0.95); backdrop-filter: blur(20px); border: 2px solid var(--coin-gold); border-radius: 20px; padding: 40px; max-width: 500px; text-align: center; box-shadow: 0 16px 64px rgba(255, 215, 0, 0.4); animation: slideUp 0.5s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    .reward-icon { font-size: 80px; margin-bottom: 20px; animation: bounce 1s ease infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .reward-title { font-size: 32px; font-weight: 800; color: var(--coin-gold); margin-bottom: 12px; }
    .reward-text { font-size: 18px; color: var(--muted); margin-bottom: 24px; }

    .player { position: fixed; inset: 0; background: #000; display: none; z-index: 9999; animation: fadeIn 0.3s ease; }
    .player.open { display: block; }
    .player-topbar { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); color: #fff; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .player-exit { padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 68, 68, 0.2); color: #fff; font-weight: 800; cursor: pointer; transition: all 0.3s ease; }
    .player-exit:hover { background: rgba(255, 68, 68, 0.4); box-shadow: 0 4px 20px rgba(255, 68, 68, 0.4); transform: scale(1.05); }
    .player-frame { position: absolute; top: 60px; left: 0; width: 100%; height: calc(100% - 60px); border: 0; }

    form { max-width: 600px; margin-top: 12px; }
    label { display: inline-block; margin-bottom: 8px; font-weight: 800; color: var(--text); font-size: 12px; text-transform: uppercase; letter-spacing: 0.12em; }
    select, textarea, input[type="text"], input[type="password"], input[type="file"] { width: 100%; padding: 12px 16px; margin-bottom: 18px; border-radius: 12px; border: 1px solid var(--border); background: rgba(91, 141, 239, 0.05); color: var(--text); outline: none; font-weight: 600; transition: all 0.3s ease; font-family: inherit; }
    select:focus, textarea:focus, input[type="text"]:focus, input[type="password"]:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(91, 141, 239, 0.2); background: rgba(91, 141, 239, 0.1); }
    textarea { resize: vertical; min-height: 140px; }
    select option { background: var(--panel); color: var(--text); }
    #status { margin-top: 16px; color: var(--muted); font-weight: 700; padding: 12px; border-radius: 12px; background: rgba(91, 141, 239, 0.05); }
    .status-ok { color: var(--success); background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); }
    .status-bad { color: var(--alert); background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); }

    .google-sites-button { font-family: 'Inter', 'Roboto', Arial, sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; padding: 14px 32px; border-radius: 12px; border: 1px solid var(--accent); cursor: pointer; color: var(--text); background: rgba(91, 141, 239, 0.15); box-shadow: 0 4px 16px rgba(91, 141, 239, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
    .google-sites-button:hover { background: rgba(91, 141, 239, 0.3); box-shadow: 0 8px 32px rgba(91, 141, 239, 0.4); transform: translateY(-4px); }

    /* ============================================
       REDESIGNED CHAT UI - COMMAND CENTER STYLE
       ============================================ */

    /* Chat page fills full main area with no padding */
    #chat.page-section { padding: 0; overflow: hidden; }

    .nova-chat-wrap {
      display: grid;
      grid-template-columns: 72px 240px 1fr 260px;
      height: 100%;
      overflow: hidden;
      background: rgba(8, 11, 24, 0.85);
    }

    /* === ICON RAIL (leftmost column) === */
    .chat-icon-rail {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 8px;
      border-right: 1px solid var(--border);
      background: rgba(5, 7, 18, 0.9);
    }

    .rail-icon {
      width: 44px; height: 44px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; cursor: pointer; transition: all 0.25s ease;
      border: 1px solid transparent; position: relative;
      color: var(--muted);
    }
    .rail-icon:hover { background: var(--hover); border-color: var(--accent); color: var(--text); border-radius: 12px; }
    .rail-icon.active { background: var(--active); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 16px rgba(91,141,239,0.3); }
    .rail-icon .rail-tooltip {
      position: absolute; left: calc(100% + 10px); top: 50%; transform: translateY(-50%);
      background: rgba(19,23,41,0.98); border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 10px; font-size: 12px; font-weight: 700; white-space: nowrap; color: var(--text);
      pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 100;
    }
    .rail-icon:hover .rail-tooltip { opacity: 1; }

    .rail-divider { width: 32px; height: 1px; background: var(--border); margin: 4px 0; }
    .rail-spacer { flex: 1; }

    /* === SIDEBAR PANEL === */
    .chat-sidebar-panel {
      display: flex; flex-direction: column;
      border-right: 1px solid var(--border);
      background: rgba(10, 13, 28, 0.8);
      overflow: hidden;
    }

    .sidebar-header {
      padding: 16px 18px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 7, 18, 0.6);
    }
    .sidebar-header-title {
      font-size: 11px; font-weight: 800; text-transform: uppercase;
      letter-spacing: 0.15em; color: var(--accent); margin-bottom: 10px;
      display: flex; align-items: center; gap: 8px;
    }
    .sidebar-header-title::before {
      content: ''; width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent); box-shadow: 0 0 8px var(--accent);
      display: inline-block;
    }

    .chat-search-box {
      display: flex; align-items: center; gap: 8px;
      background: rgba(91,141,239,0.06); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 12px;
      transition: all 0.3s ease;
    }
    .chat-search-box:focus-within { border-color: var(--accent); background: rgba(91,141,239,0.1); }
    .chat-search-box span { color: var(--muted); font-size: 14px; }
    .chat-search-box input {
      background: transparent; border: none; outline: none; color: var(--text);
      font-size: 13px; font-weight: 500; width: 100%; padding: 0; margin: 0;
    }

    .sidebar-section-label {
      font-size: 10px; font-weight: 800; text-transform: uppercase;
      letter-spacing: 0.15em; color: var(--muted); padding: 12px 18px 6px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-section-label button {
      background: none; border: none; color: var(--muted); cursor: pointer;
      font-size: 16px; line-height: 1; padding: 0; transition: color 0.2s;
    }
    .sidebar-section-label button:hover { color: var(--accent); }

    .sidebar-list { overflow-y: auto; flex: 1; padding-bottom: 12px; }
    .sidebar-list::-webkit-scrollbar { width: 4px; }
    .sidebar-list::-webkit-scrollbar-thumb { background: rgba(91,141,239,0.2); border-radius: 2px; }

    .chat-entry {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 18px; cursor: pointer;
      transition: all 0.2s ease; border-left: 2px solid transparent;
      position: relative;
    }
    .chat-entry:hover { background: rgba(91,141,239,0.08); border-left-color: rgba(91,141,239,0.4); }
    .chat-entry.active-chat { background: rgba(91,141,239,0.15); border-left-color: var(--accent); }

    .chat-entry-avatar {
      width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
      background: rgba(91,141,239,0.2); border: 1px solid var(--border);
      object-fit: cover; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: var(--accent);
    }
    .chat-entry-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 9px; }

    .online-dot {
      position: absolute; bottom: -2px; right: -2px;
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--online); border: 2px solid rgba(5,7,18,0.9);
    }

    .chat-entry-info { flex: 1; overflow: hidden; }
    .chat-entry-name { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-entry-preview { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }

    .chat-entry-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .chat-entry-time { font-size: 10px; color: var(--muted); }
    .unread-badge {
      background: var(--accent); color: white; border-radius: 10px;
      font-size: 10px; font-weight: 800; padding: 1px 6px; min-width: 18px; text-align: center;
    }

    .chat-remove-btn {
      background: none; border: none; color: transparent; cursor: pointer;
      font-size: 12px; padding: 2px 4px; border-radius: 4px; transition: all 0.2s;
    }
    .chat-entry:hover .chat-remove-btn { color: rgba(255,68,68,0.6); }
    .chat-entry:hover .chat-remove-btn:hover { color: var(--alert); background: rgba(255,68,68,0.1); }

    .add-friend-btn {
      display: flex; align-items: center; gap: 8px;
      margin: 8px 18px; padding: 10px 14px;
      background: rgba(91,141,239,0.08); border: 1px dashed rgba(91,141,239,0.3);
      border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
      font-size: 13px; font-weight: 600; color: var(--muted);
    }
    .add-friend-btn:hover { background: rgba(91,141,239,0.15); border-color: var(--accent); color: var(--text); }

    /* === MAIN CHAT AREA === */
    .chat-main-area {
      display: flex; flex-direction: column;
      background: rgba(8, 11, 24, 0.7);
      overflow: hidden; position: relative;
    }

    /* Top bar */
    .chat-topbar {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 20px; border-bottom: 1px solid var(--border);
      background: rgba(5, 7, 18, 0.7); backdrop-filter: blur(10px);
      flex-shrink: 0;
    }
    .chat-topbar-avatar {
      width: 38px; height: 38px; border-radius: 10px;
      background: rgba(91,141,239,0.2); border: 1px solid var(--border);
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 700; color: var(--accent); cursor: pointer;
      transition: all 0.2s ease;
    }
    .chat-topbar-avatar:hover { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
    .chat-topbar-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .chat-topbar-info { flex: 1; }
    .chat-topbar-name { font-size: 15px; font-weight: 800; color: var(--text); cursor: pointer; }
    .chat-topbar-name:hover { color: var(--accent); }
    .chat-topbar-status { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 5px; }
    .chat-topbar-status .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--online); display: inline-block; }

    .topbar-actions { display: flex; gap: 8px; }
    .topbar-btn {
      width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
      background: rgba(91,141,239,0.08); cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; color: var(--muted); position: relative;
    }
    .topbar-btn:hover { background: rgba(91,141,239,0.2); border-color: var(--accent); color: var(--text); }
    .topbar-btn .rail-tooltip { left: auto; right: calc(100% + 10px); }

    /* Message list */
    .chat-messages {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 2px;
      background: rgba(8,11,24,0.4);
    }
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(91,141,239,0.2); border-radius: 3px; }

    /* Date separator */
    .msg-date-sep {
      display: flex; align-items: center; gap: 12px;
      margin: 16px 0; font-size: 11px; font-weight: 700;
      color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em;
    }
    .msg-date-sep::before, .msg-date-sep::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    /* Message row */
    .nova-msg {
      display: flex; gap: 10px; padding: 4px 8px; border-radius: 10px;
      transition: background 0.15s ease; position: relative;
    }
    .nova-msg:hover { background: rgba(255,255,255,0.03); }
    .nova-msg.is-me { flex-direction: row-reverse; }

    .nova-msg-avatar {
      width: 34px; height: 34px; border-radius: 8px; flex-shrink: 0;
      background: rgba(91,141,239,0.2); border: 1px solid var(--border);
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; color: var(--accent); cursor: pointer;
      align-self: flex-end; margin-bottom: 2px;
    }
    .nova-msg-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .nova-msg-body { max-width: 68%; display: flex; flex-direction: column; }
    .nova-msg.is-me .nova-msg-body { align-items: flex-end; }

    .nova-msg-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px; }
    .nova-msg.is-me .nova-msg-header { flex-direction: row-reverse; }
    .nova-msg-sender { font-size: 12px; font-weight: 800; color: var(--accent); cursor: pointer; }
    .nova-msg-sender:hover { text-decoration: underline; }
    .nova-msg-time { font-size: 10px; color: var(--muted); }

    .nova-msg-bubble {
      padding: 10px 14px; border-radius: 14px; font-size: 14px;
      line-height: 1.55; word-wrap: break-word;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .nova-msg.is-me .nova-msg-bubble {
      background: linear-gradient(135deg, rgba(91,141,239,0.35) 0%, rgba(74,123,216,0.35) 100%);
      border-color: rgba(91,141,239,0.4);
      border-bottom-right-radius: 4px;
      border-bottom-left-radius: 14px;
    }

    .nova-msg-status { font-size: 10px; color: var(--muted); margin-top: 3px; text-align: right; }

    /* Typing indicator */
    .typing-indicator {
      display: none; align-items: center; gap: 8px;
      padding: 8px 20px; font-size: 12px; color: var(--muted); font-style: italic;
    }
    .typing-indicator.show { display: flex; }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dots span {
      width: 5px; height: 5px; border-radius: 50%; background: var(--muted);
      animation: typingPulse 1.4s ease-in-out infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingPulse { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }

    /* Input area */
    .chat-input-bar {
      padding: 16px 20px; border-top: 1px solid var(--border);
      background: rgba(5, 7, 18, 0.8); backdrop-filter: blur(10px);
      flex-shrink: 0;
    }
    .chat-input-inner {
      display: flex; align-items: center; gap: 10px;
      background: rgba(91,141,239,0.06); border: 1px solid var(--border);
      border-radius: 14px; padding: 10px 14px; transition: all 0.3s ease;
    }
    .chat-input-inner:focus-within { border-color: var(--accent); background: rgba(91,141,239,0.1); box-shadow: 0 0 20px rgba(91,141,239,0.15); }

    .input-action-btn {
      width: 32px; height: 32px; border-radius: 8px; border: none;
      background: transparent; cursor: pointer; color: var(--muted);
      font-size: 16px; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; flex-shrink: 0;
    }
    .input-action-btn:hover { background: rgba(91,141,239,0.15); color: var(--text); }

    .nova-chat-input {
      flex: 1; background: transparent; border: none; outline: none;
      color: var(--text); font-size: 14px; font-weight: 500;
      font-family: inherit; resize: none; max-height: 100px; line-height: 1.5;
    }
    .nova-chat-input::placeholder { color: var(--muted); }

    .send-btn {
      width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
      background: linear-gradient(135deg, var(--accent) 0%, #4a7bd8 100%);
      border: none; cursor: pointer; color: white; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; box-shadow: 0 2px 12px rgba(91,141,239,0.4);
    }
    .send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(91,141,239,0.6); }
    .send-btn:active { transform: scale(0.95); }

    /* Empty state */
    .chat-empty-state {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--muted); text-align: center; padding: 40px;
    }
    .chat-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .chat-empty-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--text); opacity: 0.6; }
    .chat-empty-desc { font-size: 14px; }

    /* === RIGHT PANEL (user info / members) === */
    .chat-right-panel {
      border-left: 1px solid var(--border);
      background: rgba(10, 13, 28, 0.8);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .right-panel-header {
      padding: 16px 18px; border-bottom: 1px solid var(--border);
      font-size: 11px; font-weight: 800; text-transform: uppercase;
      letter-spacing: 0.15em; color: var(--muted);
      display: flex; align-items: center; gap: 8px;
    }
    .right-panel-body { overflow-y: auto; flex: 1; padding: 12px; }
    .right-panel-body::-webkit-scrollbar { width: 4px; }
    .right-panel-body::-webkit-scrollbar-thumb { background: rgba(91,141,239,0.2); border-radius: 2px; }

    .member-card {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px; cursor: pointer;
      transition: all 0.2s ease; margin-bottom: 4px;
    }
    .member-card:hover { background: rgba(91,141,239,0.1); }
    .member-avatar {
      width: 36px; height: 36px; border-radius: 10px;
      background: rgba(91,141,239,0.2); border: 1px solid var(--border);
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: var(--accent);
      flex-shrink: 0; position: relative;
    }
    .member-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .member-name { font-size: 13px; font-weight: 700; }
    .member-status { font-size: 11px; color: var(--muted); }
    .member-online .member-name { color: var(--text); }
    .member-offline { opacity: 0.5; }

    .right-panel-stat {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 10px;
      background: rgba(91,141,239,0.06); border: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .stat-label { font-size: 11px; color: var(--muted); font-weight: 600; }
    .stat-value { font-size: 14px; font-weight: 800; color: var(--accent); }

    /* Profile page */
    .profile-container { max-width: 700px; margin: 0 auto; }
    .profile-header { display: flex; align-items: center; gap: 24px; margin-bottom: 32px; }
    .profile-pic-wrapper { position: relative; }
    .profile-pic { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent); box-shadow: 0 8px 24px rgba(91, 141, 239, 0.4); transition: all 0.3s ease; }
    .profile-pic:hover { box-shadow: 0 12px 32px rgba(91, 141, 239, 0.6); transform: scale(1.05); }
    .change-pic-btn { position: absolute; bottom: 4px; right: 4px; background: var(--accent); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(91, 141, 239, 0.4); transition: all 0.3s ease; }
    .change-pic-btn:hover { transform: scale(1.1) rotate(15deg); }
    .profile-info h2 { margin: 0 0 8px 0; font-size: 28px; font-weight: 800; }
    .profile-info .status { color: var(--muted); font-size: 15px; font-weight: 600; }

    .requests-section { margin-top: 32px; }
    .requests-section h3 { font-size: 20px; margin-bottom: 16px; }
    .request-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(19, 23, 41, 0.6); border: 1px solid var(--border); border-radius: 14px; margin-bottom: 12px; transition: all 0.3s ease; }
    body.light-mode .request-item { background: rgba(255, 255, 255, 0.8); }
    .request-item:hover { border-color: var(--accent); box-shadow: 0 4px 20px rgba(91, 141, 239, 0.2); }
    .request-user { display: flex; align-items: center; gap: 14px; }
    .request-actions { display: flex; gap: 10px; }
    .accept-btn { background: rgba(0, 255, 136, 0.2); color: var(--success); border: 1px solid var(--success); padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 800; transition: all 0.3s ease; }
    .accept-btn:hover { background: rgba(0, 255, 136, 0.3); }
    .decline-btn { background: rgba(255, 68, 68, 0.2); color: var(--alert); border: 1px solid var(--alert); padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 800; transition: all 0.3s ease; }
    .decline-btn:hover { background: rgba(255, 68, 68, 0.3); }

    .avatar-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border); object-fit: cover; margin-right: 14px; }

    .auth-status-msg { margin-top: 10px; font-weight: 700; font-size: 13px; padding: 8px 12px; border-radius: 8px; display: none; }
    .auth-status-msg.show { display: block; }
    .auth-status-msg.error { color: var(--alert); background: rgba(255,68,68,0.1); border: 1px solid rgba(255,68,68,0.3); }
    .auth-status-msg.success { color: var(--success); background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); }
    .auth-status-msg.warning { color: #ffaa00; background: rgba(255,170,0,0.1); border: 1px solid rgba(255,170,0,0.3); }

    @media (max-width: 1100px) {
      .nova-chat-wrap { grid-template-columns: 72px 220px 1fr; }
      .chat-right-panel { display: none; }
    }
    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; }
      aside { display: none; }
      .header-info { display: none; }
      .nova-chat-wrap { grid-template-columns: 1fr; }
      .chat-icon-rail, .chat-sidebar-panel { display: none; }
    }
  </style>
</head>

<body>
  <div class="bg-container">
    <div class="custom-bg" id="customBg"></div>
    <div class="gradient-wave"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="grid-overlay"></div>
    <div class="scanline"></div>
    <div class="energy-ring"></div>
    <div class="energy-ring"></div>
    <div class="energy-ring"></div>
    <div class="particles" id="particles"></div>
  </div>

  <div class="app">
    <header>
      <div class="brand">Nova</div>
      <div class="header-info">
        <div class="info-item">
          <span class="info-label">Device</span>
          <span class="info-value" id="device-type">PC</span>
        </div>
        <div class="info-item">
          <span class="info-label">Time</span>
          <span class="info-value" id="current-time">00:00:00</span>
        </div>
        <div class="info-item">
          <span class="info-label">Memory</span>
          <span class="info-value" id="memory-usage">-- MB</span>
        </div>
      </div>
      <div class="coin-display" onclick="showPage('achievements')" title="View Achievements & Rewards">
        <div class="coin-icon">ðŸª™</div>
        <span id="coin-count">0</span>
      </div>
    </header>

    <aside>
      <div class="nav-title">Pages</div>
      <nav class="nav" id="nav">
        <a data-page="home"><span class="dot"></span><span>Home</span></a>
        <a data-page="unblocked-google"><span class="dot"></span><span>Unblocked Google</span></a>
        <a data-page="games"><span class="dot"></span><span>Games</span></a>
        <a data-page="shop"><span class="dot"></span><span>Shop</span></a>
        <a data-page="achievements"><span class="dot"></span><span>Achievements</span></a>
        <a data-page="requests"><span class="dot"></span><span>Requests</span></a>
        <a data-page="water"><span class="dot"></span><span>Water</span></a>
        <a data-page="movies"><span class="dot"></span><span>Movies</span></a>
        <a data-page="tvshows"><span class="dot"></span><span>TV Shows</span></a>
        <a data-page="chat"><span class="dot"></span><span>Chat</span></a>
        <a data-page="profile"><span class="dot"></span><span>Profile</span></a>
        <a data-page="settings"><span class="dot"></span><span>Settings</span></a>
      </nav>
    </aside>

    <main>
      <!-- HOME PAGE -->
      <div id="home" class="page-section active">
        <div class="card">
          <h1>Welcome to Nova</h1>
          <p>Huge New Update just dropped â€” there's now Unblocked Google, a Shop, Achievements, Chat, Profile, Settings, and multiple new games</p>
          <div class="row">
            <div class="row-title"><span>ðŸ• Recently Played</span></div>
            <p class="empty" id="recentlyPlayedEmpty">No recent activity</p>
            <div class="scroller" id="recentlyPlayedScroller"></div>
          </div>
          <div class="row" style="margin-top: 32px;">
            <div class="row-title"><span>â­ Your Favorites</span></div>
            <p class="empty" id="favoritesEmpty">No favorites yet. Click the star on any game or movie!</p>
            <div class="scroller" id="favoritesScroller"></div>
          </div>
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <span style="color: var(--muted); font-size: 14px;"></span>
          </div>
        </div>
      </div>

      <!-- ACHIEVEMENTS PAGE -->
      <div id="achievements" class="page-section">
        <div class="card">
          <h1>ðŸ† Achievements & Rewards</h1>
          <p>Track your progress and claim daily rewards. Click any badge to see details â€” some secret badges require a code!</p>
          <div style="margin-top: 24px; padding: 24px; background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 16px;">
            <h2 style="margin: 0 0 12px 0; color: var(--coin-gold);">ðŸ’° Daily Rewards</h2>
            <p style="margin: 0 0 16px 0;">Claim your reward every 12 hours!</p>
            <div style="display: flex; align-items: center; gap: 16px;">
              <button class="btn" id="claimRewardBtn" onclick="claimDailyReward()">Claim 5 Coins</button>
              <span id="rewardTimer" style="color: var(--muted); font-weight: 700;"></span>
            </div>
          </div>
          <div style="margin-top: 32px;">
            <h2>ðŸŽ–ï¸ Your Badges <span style="font-size:14px;color:var(--muted);font-weight:500;" id="badge-progress-text"></span></h2>
            <p style="font-size:13px;color:var(--muted);margin-bottom:0;">ðŸŸ¢ Auto = earned automatically &nbsp;|&nbsp; ðŸ”‘ Code = enter a secret code to unlock</p>
            <div class="badge-container" id="badgeContainer"></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS PAGE -->
      <div id="settings" class="page-section">
        <div class="card settings-container">
          <h1>Settings</h1>
          <p>Customize your Nova experience</p>
          <div class="settings-group">
            <h2>ðŸŽ¨ Appearance</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Dark Mode / Light Mode</div><div class="setting-desc">Toggle between dark and light themes</div></div>
              <div class="toggle-switch" id="theme-toggle" onclick="toggleTheme()"></div>
            </div>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Custom Background</div><div class="setting-desc">Upload your own background image</div></div>
              <div class="file-input-wrapper">
                <input type="file" id="bg-upload" accept="image/*" onchange="uploadBackground(event)">
                <label for="bg-upload" class="file-input-label">Choose File</label>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Reset Background</div><div class="setting-desc">Remove custom background and restore default</div></div>
              <button class="btn" onclick="resetBackground()">Reset</button>
            </div>
          </div>
          <div class="settings-group">
            <h2>âš¡ Performance</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Performance Mode</div><div class="setting-desc">Disable animations for better performance</div></div>
              <div class="toggle-switch" id="performance-toggle" onclick="togglePerformance()"></div>
            </div>
          </div>
          <div class="settings-group">
            <h2>ðŸŽ® Display</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Scroll or Grid Mode</div><div class="setting-desc">Display games in scrollable row or grid layout</div></div>
              <div class="toggle-switch" id="grid-toggle" onclick="toggleGridMode()"></div>
            </div>
          </div>
          <div class="settings-group">
            <h2>ðŸ”” Notifications</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Enable Notifications</div><div class="setting-desc">Receive notifications for rewards and achievements</div></div>
              <div class="toggle-switch active" id="notifications-toggle" onclick="toggleNotifications()"></div>
            </div>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Notification Frequency</div><div class="setting-desc">How often you receive notifications</div></div>
              <select id="notification-frequency" onchange="updateNotificationFrequency()">
                <option value="all">All Notifications</option>
                <option value="important">Important Only</option>
                <option value="minimal">Minimal</option>
                <option value="none">None</option>
              </select>
            </div>
          </div>
          <div class="settings-group">
            <h2>âŒ¨ï¸ Keyboard Shortcuts</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Enable Keyboard Shortcuts</div><div class="setting-desc">Use keyboard shortcuts to navigate</div></div>
              <div class="toggle-switch active" id="shortcuts-toggle" onclick="toggleShortcuts()"></div>
            </div>
            <div style="margin-top: 16px;">
              <div class="shortcut-item"><span class="shortcut-action">Home Page</span><div class="shortcut-keys"><span class="shortcut-key">Alt</span><span>+</span><span class="shortcut-key">H</span></div></div>
              <div class="shortcut-item"><span class="shortcut-action">Games</span><div class="shortcut-keys"><span class="shortcut-key">Alt</span><span>+</span><span class="shortcut-key">G</span></div></div>
              <div class="shortcut-item"><span class="shortcut-action">Settings</span><div class="shortcut-keys"><span class="shortcut-key">Alt</span><span>+</span><span class="shortcut-key">S</span></div></div>
              <div class="shortcut-item"><span class="shortcut-action">Search</span><div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span>+</span><span class="shortcut-key">K</span></div></div>
              <div class="shortcut-item"><span class="shortcut-action">Profile</span><div class="shortcut-keys"><span class="shortcut-key">Alt</span><span>+</span><span class="shortcut-key">P</span></div></div>
            </div>
          </div>
          <div class="settings-group">
            <h2>ðŸ”’ Browser</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Prevent Ctrl+W</div><div class="setting-desc">Block accidental tab closing with Ctrl+W</div></div>
              <div class="toggle-switch" id="ctrlw-toggle" onclick="toggleCtrlW()"></div>
            </div>
          </div>
          <div class="settings-group">
            <h2>ðŸ’¾ Data</h2>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Export Settings</div><div class="setting-desc">Save your settings to a file</div></div>
              <button class="btn" onclick="exportSettings()">Export</button>
            </div>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Import Settings</div><div class="setting-desc">Load settings from a file</div></div>
              <div class="file-input-wrapper">
                <input type="file" id="settings-import" accept=".json" onchange="importSettings(event)">
                <label for="settings-import" class="file-input-label">Import</label>
              </div>
            </div>
            <div class="setting-item">
              <div class="setting-info"><div class="setting-title">Reset All Settings</div><div class="setting-desc">Clear all settings and return to defaults</div></div>
              <button class="btn" style="background: rgba(255, 68, 68, 0.2); border-color: var(--alert);" onclick="resetAllSettings()">Reset All</button>
            </div>
          </div>
        </div>
      </div>

      <!-- UNBLOCKED GOOGLE PAGE -->
      <div id="unblocked-google" class="page-section">
        <div class="card">
          <h1>Unblocked Google</h1>
          <p>This doesn't show up on your search history and everything is completely unblocked</p>
          <br>
          <button class="google-sites-button" onclick="openUnblockedGoogle()">Open Unblocked Google</button>
        </div>
      </div>

      <!-- GAMES PAGE -->
      <div id="games" class="page-section">
        <div class="card">
          <h1>Games</h1>
          <div class="search-wrap">
            <input id="games-search" class="search-input" type="text" placeholder="Search games..." autocomplete="off" />
            <button id="games-clear" class="clear-btn" type="button">Clear</button>
          </div>
          <div class="category-filter">
            <button class="category-btn active" onclick="filterGamesByCategory('all')">All</button>
            <button class="category-btn" onclick="filterGamesByCategory('action')">Action</button>
            <button class="category-btn" onclick="filterGamesByCategory('horror')">Horror</button>
            <button class="category-btn" onclick="filterGamesByCategory('sports')">Sports</button>
            <button class="category-btn" onclick="filterGamesByCategory('puzzle')">Puzzle</button>
            <button class="category-btn" onclick="filterGamesByCategory('adventure')">Adventure</button>
          </div>
          <div class="row">
            <div class="row-title"><span>Top Games</span></div>
            <div class="scroller" id="topGamesScroller"></div>
          </div>
          <div class="row" style="margin-top:22px;">
            <div class="row-title"><span>Games</span></div>
            <p class="empty" id="gamesEmpty" style="display:none;">No games match your search.</p>
            <div class="scroller" id="allGamesScroller"></div>
          </div>
        </div>
      </div>

      <!-- SHOP PAGE -->
      <div id="shop" class="page-section">
        <div class="card">
          <h1>Nova Coin Shop</h1>
          <p>Purchase offline game downloads with your Nova Coins, and make sure to login so your coins save</p>
          <div class="row">
            <div class="row-title"><span>Available Downloads</span></div>
            <div class="scroller" id="shopScroller"></div>
          </div>
          <div class="row" style="margin-top:32px;">
            <div class="row-title"><span>Your Purchases</span></div>
            <div id="purchasedItems"><p class="empty">You haven't purchased anything yet...</p></div>
          </div>
        </div>
      </div>

      <!-- REQUESTS PAGE -->
      <div id="requests" class="page-section">
        <div class="card">
          <h1>Requests</h1>
          <p>Submit a request or report a bug</p>
          <form id="requestForm">
            <label><strong>Request Type</strong></label><br>
            <select name="request_type" required>
              <option value="">Select an option</option>
              <option>Game Request</option>
              <option>Movie Request</option>
              <option>TV Show Request</option>
              <option>Anime Request</option>
              <option>Feature Suggestion</option>
              <option>Report a Bug</option>
              <option>Other</option>
            </select>
            <label><strong>Details</strong></label><br>
            <textarea name="details" required rows="5" placeholder="Describe your request..."></textarea>
            <label><strong>Name (optional)</strong></label><br>
            <input type="text" name="name" placeholder="Your name">
            <button class="btn" type="submit">Submit Request</button>
            <p id="status"></p>
          </form>
        </div>
      </div>

      <!-- WATER PAGE -->
      <div id="water" class="page-section">
        <div class="card">
          <h1>Water</h1>
          <p>Password is funni</p>
          <br>
          <button class="google-sites-button" onclick="openWaterGame()">Click this</button>
        </div>
      </div>

      <!-- MOVIES PAGE -->
      <div id="movies" class="page-section">
        <div class="card">
          <h1>Movies</h1>
          <div class="search-wrap">
            <input id="movies-search" class="search-input" placeholder="Search movies..." />
            <button id="movies-clear" class="clear-btn">Clear</button>
          </div>
          <div class="row">
            <div class="row-title">Top Movies</div>
            <div class="scroller" id="topMoviesScroller"></div>
          </div>
          <div class="row">
            <div class="row-title">All Movies</div>
            <p class="empty" id="moviesEmpty" style="display:none;">No movies match your search.</p>
            <div class="scroller" id="allMoviesScroller"></div>
          </div>
        </div>
      </div>

      <!-- TV SHOWS PAGE -->
      <div id="tvshows" class="page-section">
        <div class="card">
          <h1>TV Shows</h1>
          <div class="search-wrap">
            <input id="tvshows-search" class="search-input" placeholder="Search TV shows..." />
            <button id="tvshows-clear" class="clear-btn">Clear</button>
          </div>
          <div class="row">
            <div class="row-title">All TV Shows</div>
            <div class="scroller" id="allTVShowsScroller"></div>
          </div>
        </div>
      </div>

      <!-- ========== REDESIGNED CHAT PAGE ========== -->
      <div id="chat" class="page-section" style="padding:0;">
        <div class="nova-chat-wrap">

          <!-- ICON RAIL -->
          <div class="chat-icon-rail">
            <div class="rail-icon active" id="rail-all" onclick="switchRailTab('all')" title="All">
              ðŸ’¬
              <span class="rail-tooltip">All Chats</span>
            </div>
            <div class="rail-icon" id="rail-friends" onclick="switchRailTab('friends')" title="Friends">
              ðŸ‘¥
              <span class="rail-tooltip">Friends</span>
            </div>
            <div class="rail-icon" id="rail-groups" onclick="switchRailTab('groups')" title="Groups">
              ðŸŒ
              <span class="rail-tooltip">Groups</span>
            </div>
            <div class="rail-divider"></div>
            <div class="rail-icon" id="rail-public" onclick="openChat('Live Chatroom', null, 'global')" title="Public">
              #
              <span class="rail-tooltip">Public Channel</span>
            </div>
            <div class="rail-spacer"></div>
            <div class="rail-icon" onclick="showPage('profile')" title="Profile">
              ðŸ‘¤
              <span class="rail-tooltip">Profile</span>
            </div>
          </div>

          <!-- SIDEBAR PANEL -->
          <div class="chat-sidebar-panel">
            <div class="sidebar-header">
              <div class="sidebar-header-title">Nova Chat</div>
              <div class="chat-search-box">
                <span>ðŸ”</span>
                <input type="text" id="friend-search" placeholder="Search people..." onkeyup="filterFriends()" />
              </div>
            </div>

            <!-- Public channel entry -->
            <div class="sidebar-section-label">
              <span>Channels</span>
            </div>
            <div id="chatroom-list">
              <div class="chat-entry" id="global-entry" onclick="openChat('Live Chatroom', document.getElementById('global-entry'), 'global')">
                <div class="chat-entry-avatar" style="font-size:16px;">#</div>
                <div class="chat-entry-info">
                  <div class="chat-entry-name">Public Channel</div>
                  <div class="chat-entry-preview">Global chat for everyone</div>
                </div>
              </div>
            </div>

            <div class="sidebar-section-label" id="groups-label" style="display:none;">
              <span>Groups</span>
            </div>
            <div id="group-list"></div>

            <div class="sidebar-section-label">
              <span>Friends</span>
              <button onclick="addFriend()" title="Add Friend">+</button>
            </div>
            <div class="sidebar-list" id="friend-list"></div>

            <div class="add-friend-btn" onclick="addFriend()">
              <span>+</span> Add Friend
            </div>
          </div>

          <!-- MAIN CHAT AREA -->
          <div class="chat-main-area" id="chat-pane">

            <!-- Empty state (shown when no chat selected) -->
            <div class="chat-empty-state" id="chat-empty-state">
              <div class="chat-empty-icon">ðŸ’¬</div>
              <div class="chat-empty-title">No Conversation Selected</div>
              <div class="chat-empty-desc">Pick a friend or channel from the left to start chatting</div>
            </div>

            <!-- Chat view (hidden until a chat is selected) -->
            <div id="chat-active-view" style="display:none; flex-direction:column; height:100%;">
              <!-- Top bar -->
              <div class="chat-topbar">
                <div class="chat-topbar-avatar" id="topbar-avatar" onclick="viewProfileFromChat()">?</div>
                <div class="chat-topbar-info">
                  <div class="chat-topbar-name" id="active-chat-user" onclick="viewProfileFromChat()">â€”</div>
                  <div class="chat-topbar-status" id="topbar-status">
                    <span class="status-dot"></span> Online
                  </div>
                </div>
                <div class="topbar-actions">
                  <button class="topbar-btn" id="make-group-btn" onclick="createGroup()" style="display:none;" title="Create Group">
                    âž•
                    <span class="rail-tooltip">Create Group</span>
                  </button>
                  <button class="topbar-btn" id="manage-group-btn" onclick="alert('Group management coming soon!')" style="display:none;" title="Manage Group">
                    âš™ï¸
                    <span class="rail-tooltip">Manage Group</span>
                  </button>
                  <button class="topbar-btn" onclick="changeChatBG()" title="Change BG">
                    ðŸ–¼ï¸
                    <span class="rail-tooltip">Change Background</span>
                  </button>
                </div>
              </div>

              <!-- Messages -->
              <div id="chat-msgs" class="chat-messages"></div>

              <!-- Typing indicator -->
              <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dots">
                  <span></span><span></span><span></span>
                </div>
                <span id="typing-text">Someone is typing...</span>
              </div>

              <!-- Input bar -->
              <div class="chat-input-bar">
                <div class="chat-input-inner">
                  <button class="input-action-btn" title="Emoji">ðŸ˜Š</button>
                  <textarea
                    id="chat-input"
                    class="nova-chat-input"
                    placeholder="Send a message..."
                    rows="1"
                    onkeydown="handleChatKey(event)"
                    oninput="autoResizeInput(this)"
                  ></textarea>
                  <button class="send-btn" onclick="sendMsg()" title="Send">âž¤</button>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT PANEL -->
          <div class="chat-right-panel">
            <div class="right-panel-header">ðŸ“Š Info</div>
            <div class="right-panel-body" id="right-panel-body">
              <div style="color:var(--muted);font-size:13px;text-align:center;margin-top:24px;">
                Select a chat to see info
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- ========== END CHAT PAGE ========== -->

      <!-- PROFILE PAGE -->
      <div id="profile" class="page-section">
        <div class="card profile-container">
          <div class="profile-header">
            <div class="profile-pic-wrapper">
              <img id="profile-pic" class="profile-pic" src="https://via.placeholder.com/120" alt="Profile Picture">
              <button class="change-pic-btn" onclick="document.getElementById('pfp-upload').click()">ðŸ“·</button>
              <input type="file" id="pfp-upload" accept="image/*" style="display:none;" onchange="uploadProfilePic(event)">
            </div>
            <div class="profile-info">
              <h2 id="profile-username">Guest</h2>
              <p class="status" id="profile-status">Offline</p>
              <div class="status-update" style="margin-top: 12px;">
                <input type="text" id="status-input" class="status-input" placeholder="What's on your mind?" maxlength="100">
                <button class="btn" onclick="updateStatus()" style="padding: 8px 16px;">Update</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:20px;">
            <h3 style="margin-top:0;">Login / Register</h3>
            <input type="text" id="login-username" placeholder="Enter username" style="margin-bottom:10px;">
            <input type="password" id="login-password" placeholder="Enter password" style="margin-bottom:10px;">
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" onclick="loginUser()">Login</button>
              <button class="btn" onclick="registerUser()">Register</button>
              <button class="btn" onclick="logoutUser()">Logout</button>
            </div>
            <div id="auth-status-msg" class="auth-status-msg"></div>
          </div>

          <div class="requests-section">
            <h3>Friend Requests</h3>
            <div id="requests-list"><p class="empty">No pending requests</p></div>
          </div>
        </div>
      </div>

      <!-- USER PROFILE VIEW PAGE -->
      <div id="user-profile" class="page-section">
        <div class="card profile-container">
          <button class="btn" onclick="goBackFromUserProfile()" style="margin-bottom: 20px;">â† Back</button>
          <div class="profile-header">
            <div class="profile-pic-wrapper">
              <img id="user-profile-pic" class="profile-pic" src="https://via.placeholder.com/120" alt="Profile Picture">
            </div>
            <div class="profile-info">
              <h2 id="user-profile-username">Loading...</h2>
              <p class="status" id="user-profile-status">Offline</p>
              <p class="status" id="user-profile-custom-status" style="margin-top: 8px; font-style: italic;"></p>
            </div>
          </div>
          <div class="card" style="margin-top:20px;">
            <h3 style="margin-top:0;">Actions</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;" id="user-profile-actions">
              <button class="btn" onclick="sendFriendRequestToUser()">Add Friend</button>
              <button class="btn" onclick="messageUser()">Send Message</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- PLAYER OVERLAY -->
  <div class="player" id="player">
    <div class="player-topbar">
      <div id="playerName">Content</div>
      <button id="closeBtn" class="player-exit">Exit</button>
    </div>
    <iframe id="playerFrame" class="player-frame"></iframe>
  </div>

  <!-- NOTIFICATION -->
  <div class="notification" id="notification">
    <div class="notification-icon">ðŸ“¢</div>
    <div class="notification-text" id="notificationText">Notification</div>
  </div>

  <!-- DAILY REWARD MODAL -->
  <div class="modal" id="rewardModal">
    <div class="modal-content">
      <div class="reward-icon">ðŸŽ‰</div>
      <div class="reward-title">Daily Reward Claimed!</div>
      <div class="reward-text">You received <strong>5 Nova Coins</strong></div>
      <button class="btn" onclick="closeRewardModal()">Awesome!</button>
    </div>
  </div>

<script>
console.log('========================================');
console.log('NOVA APP STARTING');
console.log('========================================');

(function() { emailjs.init("WVn4FyckWoY68y1Kp"); })();

const firebaseConfig = {
  apiKey: "AIzaSyB-IbnRdC9RwT4eZPtpgH9F1fj5OKeRw9U",
  authDomain: "unblocked-hub-chat.firebaseapp.com",
  databaseURL: "https://unblocked-hub-chat-default-rtdb.firebaseio.com",
  projectId: "unblocked-hub-chat",
  storageBucket: "unblocked-hub-chat.firebasestorage.app",
  messagingSenderId: "192995986961",
  appId: "1:192995986961:web:6ee8f3ce513ac3b744ebb0",
  measurementId: "G-QDX7PP5JXL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

window.myName = null;
let activeChat = null, chatType = "none", myFriends = [];
let viewedUserName = null;
let previousPage = null;
let currentRailTab = 'all';

// ============================================
// SETTINGS SYSTEM
// ============================================
const SETTINGS_KEY = 'nova_settings';
let preventCtrlW = false;
let keyboardShortcutsEnabled = true;
let notificationsEnabled = true;
let notificationFrequency = 'all';

function loadSettings() {
  const saved = localStorage.getItem(SETTINGS_KEY);
  if (saved) {
    try {
      const settings = JSON.parse(saved);
      if (settings.lightMode) { document.body.classList.add('light-mode'); document.getElementById('theme-toggle').classList.add('active'); }
      if (settings.performanceMode) { document.body.classList.add('performance-mode'); document.getElementById('performance-toggle').classList.add('active'); }
      if (settings.gridMode) { document.body.classList.add('grid-mode'); document.getElementById('grid-toggle').classList.add('active'); }
      if (settings.preventCtrlW) { preventCtrlW = true; document.getElementById('ctrlw-toggle').classList.add('active'); }
      if (settings.keyboardShortcuts !== undefined) { keyboardShortcutsEnabled = settings.keyboardShortcuts; if (!keyboardShortcutsEnabled) document.getElementById('shortcuts-toggle').classList.remove('active'); }
      if (settings.notifications !== undefined) { notificationsEnabled = settings.notifications; if (!notificationsEnabled) document.getElementById('notifications-toggle').classList.remove('active'); }
      if (settings.notificationFrequency) { notificationFrequency = settings.notificationFrequency; document.getElementById('notification-frequency').value = notificationFrequency; }
      if (settings.customBackground) { const bgEl = document.getElementById('customBg'); bgEl.style.backgroundImage = `url(${settings.customBackground})`; bgEl.classList.add('active'); }
    } catch (e) { console.error('Failed to load settings:', e); }
  }
}

function saveSettings() {
  const settings = {
    lightMode: document.body.classList.contains('light-mode'),
    performanceMode: document.body.classList.contains('performance-mode'),
    gridMode: document.body.classList.contains('grid-mode'),
    preventCtrlW, keyboardShortcuts: keyboardShortcutsEnabled,
    notifications: notificationsEnabled, notificationFrequency,
    customBackground: document.getElementById('customBg').style.backgroundImage.slice(5, -2)
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

function toggleTheme() {
  document.body.classList.toggle('light-mode');
  document.getElementById('theme-toggle').classList.toggle('active');
  saveSettings();
  unlockBadge('theme-switcher');
}
function togglePerformance() { document.body.classList.toggle('performance-mode'); document.getElementById('performance-toggle').classList.toggle('active'); saveSettings(); }
function toggleGridMode() { document.body.classList.toggle('grid-mode'); document.getElementById('grid-toggle').classList.toggle('active'); saveSettings(); }
function toggleCtrlW() { preventCtrlW = !preventCtrlW; document.getElementById('ctrlw-toggle').classList.toggle('active'); saveSettings(); }
function toggleShortcuts() { keyboardShortcutsEnabled = !keyboardShortcutsEnabled; document.getElementById('shortcuts-toggle').classList.toggle('active'); saveSettings(); showNotification(keyboardShortcutsEnabled ? 'Keyboard shortcuts enabled' : 'Keyboard shortcuts disabled', keyboardShortcutsEnabled ? 'success' : 'warning'); }
function toggleNotifications() { notificationsEnabled = !notificationsEnabled; document.getElementById('notifications-toggle').classList.toggle('active'); saveSettings(); }
function updateNotificationFrequency() { notificationFrequency = document.getElementById('notification-frequency').value; saveSettings(); showNotification(`Notification frequency set to ${notificationFrequency}`, 'success'); }

function uploadBackground(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) { const bgEl = document.getElementById('customBg'); bgEl.style.backgroundImage = `url(${e.target.result})`; bgEl.classList.add('active'); saveSettings(); showNotification('Custom background applied!', 'success'); };
  reader.readAsDataURL(file);
}
function resetBackground() { const bgEl = document.getElementById('customBg'); bgEl.style.backgroundImage = ''; bgEl.classList.remove('active'); saveSettings(); showNotification('Background reset to default!', 'success'); }

function exportSettings() {
  const settings = localStorage.getItem(SETTINGS_KEY);
  if (!settings) { showNotification('No settings to export!', 'warning'); return; }
  const blob = new Blob([settings], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'nova-settings.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  showNotification('Settings exported!', 'success');
}

function importSettings(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) { try { JSON.parse(e.target.result); localStorage.setItem(SETTINGS_KEY, e.target.result); showNotification('Settings imported! Refreshing...', 'success'); setTimeout(() => location.reload(), 1500); } catch (err) { showNotification('Invalid settings file!', 'error'); } };
  reader.readAsText(file);
}

function resetAllSettings() { if (confirm('Are you sure you want to reset all settings? This cannot be undone.')) { localStorage.removeItem(SETTINGS_KEY); showNotification('Settings reset! Refreshing...', 'success'); setTimeout(() => location.reload(), 1500); } }

// ============================================
// KEYBOARD SHORTCUTS
// ============================================
document.addEventListener('keydown', (e) => {
  if (preventCtrlW && e.ctrlKey && e.key === 'w') { e.preventDefault(); showNotification('Closing tabs is disabled in settings!', 'warning'); return; }
  if (!keyboardShortcutsEnabled) return;
  if (e.ctrlKey && e.key === 'k') { e.preventDefault(); const searchInput = document.querySelector('.page-section.active .search-input'); if (searchInput) searchInput.focus(); return; }
  if (e.altKey) {
    switch(e.key.toLowerCase()) {
      case 'h': e.preventDefault(); showPage('home'); break;
      case 'g': e.preventDefault(); showPage('games'); break;
      case 's': e.preventDefault(); showPage('settings'); break;
      case 'p': e.preventDefault(); showPage('profile'); break;
    }
  }
});

// ============================================
// NOTIFICATION SYSTEM
// ============================================
function showNotification(text, type = 'success') {
  if (!notificationsEnabled) return;
  if (notificationFrequency === 'none') return;
  if (notificationFrequency === 'important' && type !== 'error' && type !== 'warning') return;
  if (notificationFrequency === 'minimal' && type === 'success') return;
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  notification.className = 'notification';
  notification.classList.add(type);
  notificationText.textContent = text;
  notification.classList.add('show');
  setTimeout(() => { notification.classList.remove('show'); }, 3000);
}

// ============================================
// DEVICE & SYSTEM INFO
// ============================================
function detectDevice() {
  const ua = navigator.userAgent;
  let device = 'PC';
  if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) device = 'Tablet';
  else if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) device = 'Phone';
  document.getElementById('device-type').textContent = device;
}
function updateClock() {
  const now = new Date(); let hours = now.getHours();
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12; hours = hours ? hours : 12;
  document.getElementById('current-time').textContent = `${String(hours).padStart(2,'0')}:${minutes}:${seconds} ${ampm}`;
}
function updateMemoryUsage() {
  if (performance.memory) document.getElementById('memory-usage').textContent = `${(performance.memory.usedJSHeapSize / 1048576).toFixed(1)} MB`;
  else document.getElementById('memory-usage').textContent = 'N/A';
}
detectDevice(); setInterval(updateClock, 1000); setInterval(updateMemoryUsage, 2000); updateClock(); updateMemoryUsage();

// ============================================
// PARTICLE SYSTEM
// ============================================
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  for (let i = 0; i < 30; i++) {
    const particle = document.createElement('div'); particle.className = 'particle';
    const startX = Math.random() * 100;
    const drift = (Math.random() - 0.5) * 200;
    const duration = 15 + Math.random() * 15;
    const delay = Math.random() * 10;
    const size = 2 + Math.random() * 3;
    particle.style.left = startX + '%';
    particle.style.setProperty('--drift', drift + 'px');
    particle.style.animationDuration = duration + 's';
    particle.style.animationDelay = delay + 's';
    particle.style.width = size + 'px';
    particle.style.height = size + 'px';
    const colors = ['rgba(91, 141, 239, 0.6)', 'rgba(0, 255, 136, 0.6)', 'rgba(147, 51, 234, 0.6)'];
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
    particlesContainer.appendChild(particle);
  }
}
createParticles();

// ============================================
// FAVORITES & RECENTLY PLAYED
// ============================================
let favorites = []; let recentlyPlayed = [];
function loadUserData() {
  const favData = localStorage.getItem('nova_favorites');
  const recentData = localStorage.getItem('nova_recently_played');
  if (favData) favorites = JSON.parse(favData);
  if (recentData) recentlyPlayed = JSON.parse(recentData);
  renderFavorites(); renderRecentlyPlayed();
}
function saveFavorites() { localStorage.setItem('nova_favorites', JSON.stringify(favorites)); }
function saveRecentlyPlayed() { localStorage.setItem('nova_recently_played', JSON.stringify(recentlyPlayed)); }

function toggleFavorite(id, name, url, thumb, type) {
  const index = favorites.findIndex(f => f.id === id);
  if (index > -1) { favorites.splice(index, 1); showNotification(`Removed ${name} from favorites`, 'warning'); }
  else {
    favorites.push({ id, name, url, thumb, type });
    showNotification(`Added ${name} to favorites!`, 'success');
    unlockBadge('first-favorite');
    if (favorites.length >= 5) unlockBadge('favorite-five');
    if (favorites.length >= 10) unlockBadge('collector');
  }
  saveFavorites(); renderFavorites();
  const btn = document.querySelector(`[data-fav-id="${id}"]`);
  if (btn) { btn.textContent = index > -1 ? 'â˜†' : 'â­'; btn.classList.toggle('active', index === -1); }
}

function addToRecentlyPlayed(id, name, url, thumb, type) {
  recentlyPlayed = recentlyPlayed.filter(r => r.id !== id);
  recentlyPlayed.unshift({ id, name, url, thumb, type, playedAt: Date.now() });
  if (recentlyPlayed.length > 10) recentlyPlayed = recentlyPlayed.slice(0, 10);
  saveRecentlyPlayed(); renderRecentlyPlayed();
  unlockBadge('first-game');
  if (recentlyPlayed.length >= 5) unlockBadge('game-enthusiast');
  if (recentlyPlayed.length >= 10) unlockBadge('gamer');
}

function renderFavorites() {
  const scroller = document.getElementById('favoritesScroller');
  const empty = document.getElementById('favoritesEmpty');
  if (favorites.length === 0) { empty.style.display = 'block'; scroller.innerHTML = ''; return; }
  empty.style.display = 'none'; scroller.innerHTML = '';
  favorites.forEach(item => {
    const div = document.createElement('div'); div.className = item.type;
    div.innerHTML = `<button class="favorite-btn active" data-fav-id="${item.id}" onclick="event.stopPropagation(); toggleFavorite('${item.id}', '${item.name}', '${item.url}', '${item.thumb}', '${item.type}')">â­</button><img class="thumb" src="${item.thumb}" alt="${item.name}"><strong>${item.name}</strong><button class="${item.type}-btn" data-url="${item.url}" data-title="${item.name}">${item.type === 'game' ? 'Launch' : 'Watch'}</button>`;
    scroller.appendChild(div);
  });
}

function renderRecentlyPlayed() {
  const scroller = document.getElementById('recentlyPlayedScroller');
  const empty = document.getElementById('recentlyPlayedEmpty');
  if (recentlyPlayed.length === 0) { empty.style.display = 'block'; scroller.innerHTML = ''; return; }
  empty.style.display = 'none'; scroller.innerHTML = '';
  recentlyPlayed.forEach(item => {
    const div = document.createElement('div'); div.className = item.type;
    const isFavorite = favorites.some(f => f.id === item.id);
    div.innerHTML = `<button class="favorite-btn ${isFavorite ? 'active' : ''}" data-fav-id="${item.id}" onclick="event.stopPropagation(); toggleFavorite('${item.id}', '${item.name}', '${item.url}', '${item.thumb}', '${item.type}')">${isFavorite ? 'â­' : 'â˜†'}</button><img class="thumb" src="${item.thumb}" alt="${item.name}"><strong>${item.name}</strong><button class="${item.type}-btn" data-url="${item.url}" data-title="${item.name}">${item.type === 'game' ? 'Launch' : 'Watch'}</button>`;
    scroller.appendChild(div);
  });
}

// ============================================
// DAILY REWARDS
// ============================================
function checkDailyReward() {
  const lastClaim = localStorage.getItem('last_reward_claim');
  const now = Date.now(); const twelveHours = 12 * 60 * 60 * 1000;
  if (!lastClaim || (now - parseInt(lastClaim)) >= twelveHours) {
    document.getElementById('claimRewardBtn').disabled = false;
    document.getElementById('rewardTimer').textContent = 'Available now!';
  } else {
    document.getElementById('claimRewardBtn').disabled = true;
    updateRewardTimer();
  }
}

function updateRewardTimer() {
  const lastClaim = localStorage.getItem('last_reward_claim'); if (!lastClaim) return;
  const now = Date.now();
  const remaining = parseInt(lastClaim) + 12 * 60 * 60 * 1000 - now;
  if (remaining <= 0) { document.getElementById('claimRewardBtn').disabled = false; document.getElementById('rewardTimer').textContent = 'Available now!'; return; }
  const hours = Math.floor(remaining / (1000 * 60 * 60));
  const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
  document.getElementById('rewardTimer').textContent = `Next reward in: ${hours}h ${minutes}m ${seconds}s`;
  setTimeout(updateRewardTimer, 1000);
}

function claimDailyReward() {
  novaCoins += 5; saveCoinData(); updateCoinDisplay();
  localStorage.setItem('last_reward_claim', Date.now().toString());
  document.getElementById('rewardModal').classList.add('show');
  document.getElementById('claimRewardBtn').disabled = true;
  showNotification('+5 Nova Coins earned!', 'success');
  unlockBadge('daily-login');
  updateRewardTimer();
}
function closeRewardModal() { document.getElementById('rewardModal').classList.remove('show'); }

// ============================================
// ACHIEVEMENTS / BADGES SYSTEM
// ============================================
const BADGES = {
  'welcome':         { name: 'Welcome',          icon: 'ðŸ‘‹', desc: 'Create your account',             type: 'auto' },
  'first-game':      { name: 'First Steps',       icon: 'ðŸŽ®', desc: 'Play your first game',            type: 'auto' },
  'first-favorite':  { name: 'Favorite Found',    icon: 'â­', desc: 'Add your first favorite',         type: 'auto' },
  'daily-login':     { name: 'Daily Visitor',     icon: 'ðŸ“…', desc: 'Claim a daily reward',            type: 'auto' },
  'first-setting':   { name: 'Customizer',        icon: 'ðŸŽ¨', desc: 'Open the settings page',         type: 'auto' },
  'explorer':        { name: 'Explorer',           icon: 'ðŸ§­', desc: 'Visit 5 different pages',        type: 'auto' },
  'first-friend':    { name: 'Friend Maker',      icon: 'ðŸ‘‹', desc: 'Accept your first friend',       type: 'auto' },
  'first-message':   { name: 'Conversationalist', icon: 'ðŸ’¬', desc: 'Send your first chat message',   type: 'auto' },
  'searcher':        { name: 'Searcher',           icon: 'ðŸ”', desc: 'Use search in the app',          type: 'auto' },
  'profile-editor':  { name: 'Profile Editor',    icon: 'âœï¸', desc: 'Update your profile picture',    type: 'auto' },
  'theme-switcher':  { name: 'Theme Switcher',    icon: 'ðŸŒ“', desc: 'Toggle between light/dark mode', type: 'auto' },
  'movie-starter':   { name: 'Movie Starter',     icon: 'ðŸŽ¬', desc: 'Watch your first movie',         type: 'auto' },
  'window-shopper':  { name: 'Window Shopper',    icon: 'ðŸ›ï¸', desc: 'Visit the shop',                 type: 'auto' },
  'favorite-five':   { name: 'Favorite Five',     icon: 'ðŸŒŸ', desc: 'Add 5 items to favorites',       type: 'auto' },
  'collector':       { name: 'Collector',          icon: 'ðŸ“š', desc: 'Add 10 items to favorites',      type: 'auto' },
  'coin-collector':  { name: 'Coin Collector',    icon: 'ðŸª™', desc: 'Earn 50 Nova Coins',             type: 'auto' },
  'big-spender':     { name: 'Big Spender',       icon: 'ðŸ’°', desc: 'Make your first purchase',       type: 'auto' },
  'social-butterfly':{ name: 'Social Butterfly',  icon: 'ðŸ‘¥', desc: 'Add 5 friends',                  type: 'auto' },
  'game-enthusiast': { name: 'Game Enthusiast',   icon: 'ðŸ•¹ï¸', desc: 'Play 5 different games',         type: 'auto' },
  'gamer':           { name: 'Hardcore Gamer',    icon: 'ðŸ‘¾', desc: 'Play 10 different games',        type: 'auto' },
  'status-setter':   { name: 'Status Setter',     icon: 'ðŸ’­', desc: 'Set a custom status message',   type: 'auto' },
  'chat-active':     { name: 'Chat Active',       icon: 'ðŸ“¨', desc: 'Send 10 chat messages',          type: 'auto' },
  'night-owl':       { name: 'Night Owl',         icon: 'ðŸ¦‰', desc: 'Use Nova after midnight',        type: 'auto' },
  'early-bird':      { name: 'Early Bird',        icon: 'ðŸŒ…', desc: 'Use Nova before 7AM',            type: 'auto' },
  'speed-runner':    { name: 'Speed Runner',      icon: 'âš¡', desc: 'Launch a game within 10s of opening Nova', type: 'auto' },
  'secret-agent':    { name: 'Secret Agent',      icon: 'ðŸ•µï¸', desc: 'You know the secrets...', type: 'code', code: 'agent007' },
  'dev-mode':        { name: 'Dev Mode',          icon: 'ðŸ’»', desc: 'Developer access granted', type: 'code', code: 'novadev' },
  'golden-key':      { name: 'Golden Key',        icon: 'ðŸ—ï¸', desc: 'Unlock the golden vault', type: 'code', code: 'goldkey' },
  'shadow-master':   { name: 'Shadow Master',     icon: 'ðŸŒ‘', desc: 'Master of the shadows',    type: 'code', code: 'shadow99' },
  'nova-founder':    { name: 'Nova Founder',      icon: 'ðŸš€', desc: 'An OG Nova user',          type: 'code', code: 'novaogl' },
};

let unlockedBadges = [];
let pagesVisited = new Set();
let chatMessageCount = 0;
let speedRunnerChecked = false;
const BADGES_KEY = 'nova_badges_v2';
const CHAT_COUNT_KEY = 'nova_chat_count';

function loadBadges() {
  const saved = localStorage.getItem(BADGES_KEY);
  if (saved) { try { unlockedBadges = JSON.parse(saved); } catch(e) { unlockedBadges = []; } }
  else { const old = localStorage.getItem('nova_badges'); if (old) { try { unlockedBadges = JSON.parse(old); } catch(e) { unlockedBadges = []; } } }
  const cc = localStorage.getItem(CHAT_COUNT_KEY);
  if (cc) chatMessageCount = parseInt(cc) || 0;
  renderBadges();
}

function saveBadges() { localStorage.setItem(BADGES_KEY, JSON.stringify(unlockedBadges)); }

function unlockBadge(badgeId) {
  if (unlockedBadges.includes(badgeId)) return;
  if (!BADGES[badgeId]) return;
  unlockedBadges.push(badgeId);
  saveBadges();
  const badge = BADGES[badgeId];
  showNotification(`ðŸ† Badge Unlocked: ${badge.name}!`, 'success');
  renderBadges();
}

function tryCodeBadge(badgeId, inputEl, btnEl) {
  const entered = (inputEl.value || '').trim().toLowerCase();
  const badge = BADGES[badgeId];
  if (!badge || badge.type !== 'code') return;
  if (entered === badge.code) {
    unlockBadge(badgeId);
    inputEl.style.borderColor = 'var(--success)';
    btnEl.textContent = 'âœ“ Unlocked!';
    btnEl.disabled = true;
    setTimeout(() => { inputEl.parentElement.classList.remove('show'); }, 1500);
  } else {
    inputEl.style.borderColor = 'var(--alert)';
    inputEl.placeholder = 'Wrong code! Try again...';
    inputEl.value = '';
    setTimeout(() => { inputEl.style.borderColor = ''; inputEl.placeholder = 'Enter secret code...'; }, 1500);
  }
}

function renderBadges() {
  const container = document.getElementById('badgeContainer'); container.innerHTML = '';
  const total = Object.keys(BADGES).length;
  const earned = unlockedBadges.filter(id => BADGES[id]).length;
  const prog = document.getElementById('badge-progress-text');
  if (prog) prog.textContent = `(${earned} / ${total})`;
  Object.keys(BADGES).forEach(badgeId => {
    const badge = BADGES[badgeId];
    const unlocked = unlockedBadges.includes(badgeId);
    const isCode = badge.type === 'code';
    const div = document.createElement('div');
    div.className = `badge ${unlocked ? 'unlocked' : 'locked'} ${isCode && !unlocked ? 'code-required' : ''}`;
    const tagLabel = unlocked ? 'earned' : (isCode ? 'code' : 'auto');
    const tagText  = unlocked ? 'âœ“ Earned' : (isCode ? 'ðŸ”‘ Code' : 'ðŸŸ¢ Auto');
    div.innerHTML = `<div class="badge-icon">${badge.icon}</div><div class="badge-name">${badge.name}</div><div class="badge-desc">${badge.desc}</div><span class="badge-tag ${tagLabel}">${tagText}</span>${isCode && !unlocked ? `<div class="badge-code-area" id="code-area-${badgeId}"><input class="badge-code-input" id="code-input-${badgeId}" type="text" placeholder="Enter secret code..." /><button class="badge-code-submit" id="code-btn-${badgeId}">Submit</button></div>` : ''}`;
    if (isCode && !unlocked) {
      div.addEventListener('click', (e) => {
        if (e.target.classList.contains('badge-code-input') || e.target.classList.contains('badge-code-submit')) return;
        const area = document.getElementById(`code-area-${badgeId}`);
        area.classList.toggle('show');
        if (area.classList.contains('show')) document.getElementById(`code-input-${badgeId}`).focus();
      });
    }
    container.appendChild(div);
    if (isCode && !unlocked) {
      const inp = document.getElementById(`code-input-${badgeId}`);
      const btn = document.getElementById(`code-btn-${badgeId}`);
      btn.addEventListener('click', () => tryCodeBadge(badgeId, inp, btn));
      inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryCodeBadge(badgeId, inp, btn); });
    }
  });
}

function checkTimeBadges() {
  const h = new Date().getHours();
  if (h >= 0 && h < 4) unlockBadge('night-owl');
  if (h >= 4 && h < 7) unlockBadge('early-bird');
}
checkTimeBadges();

const _appOpenTime = Date.now();
function checkSpeedRunner() {
  if (!speedRunnerChecked) {
    speedRunnerChecked = true;
    if (Date.now() - _appOpenTime < 10000) unlockBadge('speed-runner');
  }
}

// ============================================
// STATUS UPDATES
// ============================================
function updateStatus() {
  if (!window.myName) { showNotification('Please login first', 'warning'); return; }
  const statusInput = document.getElementById('status-input');
  const status = statusInput.value.trim(); if (!status) return;
  db.ref("users/" + window.myName + "/customStatus").set(status);
  statusInput.value = '';
  showNotification('Status updated!', 'success');
  unlockBadge('status-setter');
}

// ============================================
// NOVA COIN SYSTEM
// ============================================
let novaCoins = 0; let purchasedGames = []; let coinInterval = null;
function updateCoinDisplay() {
  document.getElementById('coin-count').textContent = novaCoins;
  if (novaCoins >= 50) unlockBadge('coin-collector');
}
function earnCoin() { if (!window.myName) return; novaCoins++; saveCoinData(); updateCoinDisplay(); showNotification('+1 Nova Coin earned!', 'success'); }
function saveCoinData() { if (!window.myName) return; db.ref("users/" + window.myName + "/coins").set(novaCoins); db.ref("users/" + window.myName + "/purchasedGames").set(purchasedGames); }
function loadCoinData() {
  if (!window.myName) { novaCoins = 0; purchasedGames = []; updateCoinDisplay(); return; }
  db.ref("users/" + window.myName + "/coins").once("value", (snap) => { novaCoins = snap.val() || 0; updateCoinDisplay(); });
  db.ref("users/" + window.myName + "/purchasedGames").once("value", (snap) => { purchasedGames = snap.val() || []; if (document.getElementById('shop').classList.contains('active')) renderShop(); });
}
function startCoinEarning() { if (coinInterval) clearInterval(coinInterval); coinInterval = setInterval(earnCoin, 300000); }
function stopCoinEarning() { if (coinInterval) { clearInterval(coinInterval); coinInterval = null; } }
updateCoinDisplay();

// ============================================
// SHOP
// ============================================
const SHOP_ITEMS = [
  { id: "minecraft-download", name: "Minecraft", price: 10, thumb: "https://jeremyryanknight2012.github.io/My-Website/thumbnails/minecraft.png", downloadFile: "minecraft.html" },
  { id: "mario64-download", name: "Super Mario 64", price: 10, thumb: "https://jeremyryanknight2012.github.io/My-Website/thumbnails/supermario64.png", downloadFile: "mario64.html" },
  { id: "balatro-download", name: "Balatro", price: 10, thumb: "https://jeremyryanknight2012.github.io/My-Website/thumbnails/balatro.png", downloadFile: "balatro.html" },
  { id: "tattletail-download", name: "Tattletail", price: 5, thumb: "https://jeremyryanknight2012.github.io/My-Website/thumbnails/tattletail.png", downloadFile: "tattletail.html" }
];

function renderShop() {
  const shopScroller = document.getElementById('shopScroller'); shopScroller.innerHTML = '';
  SHOP_ITEMS.forEach(item => {
    const isPurchased = purchasedGames.includes(item.id);
    const canAfford = novaCoins >= item.price;
    const div = document.createElement('div'); div.className = 'shop-item';
    div.innerHTML = `<img class="thumb" src="${item.thumb}" alt="${item.name}"><strong>${item.name}</strong><div class="price"><div class="coin-icon">ðŸª™</div><span>${item.price}</span></div>${isPurchased ? '<button class="btn" style="background:rgba(0,255,136,0.2);border-color:var(--success);">Purchased âœ“</button>' : `<button class="buy-btn" onclick="purchaseItem('${item.id}')" ${!canAfford ? 'disabled' : ''}>${canAfford ? 'Buy Now' : 'Not Enough Coins'}</button>`}`;
    shopScroller.appendChild(div);
  });
  renderPurchasedItems();
}

function purchaseItem(itemId) {
  if (!window.myName) { showNotification('Please login to make purchases!', 'warning'); return; }
  const item = SHOP_ITEMS.find(i => i.id === itemId); if (!item) return;
  if (novaCoins >= item.price) {
    novaCoins -= item.price; purchasedGames.push(itemId); saveCoinData(); updateCoinDisplay(); renderShop();
    unlockBadge('big-spender'); showNotification(`${item.name} purchased! Downloading...`, 'success');
    fetch(item.downloadFile).then(r => r.blob()).then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = item.downloadFile;
      document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
    }).catch(() => showNotification('Download failed. Make sure files are available.', 'error'));
  } else { showNotification('Not enough Nova Coins!', 'warning'); }
}

function renderPurchasedItems() {
  const container = document.getElementById('purchasedItems');
  if (purchasedGames.length === 0) { container.innerHTML = '<p class="empty">You haven\'t purchased anything yet.</p>'; return; }
  container.innerHTML = '';
  purchasedGames.forEach(gameId => {
    const item = SHOP_ITEMS.find(i => i.id === gameId); if (!item) return;
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:16px;padding:16px;background:rgba(19,23,41,0.6);border:1px solid var(--border);border-radius:14px;margin-bottom:12px;';
    div.innerHTML = `<img src="${item.thumb}" style="width:60px;height:60px;border-radius:8px;object-fit:contain;background:rgba(0,0,0,0.3);"><div style="flex:1;"><strong style="display:block;margin-bottom:4px;">${item.name}</strong><span style="color:var(--muted);font-size:13px;">Purchased</span></div><button class="btn" onclick="redownloadGame('${item.downloadFile}', '${item.name}')" style="white-space:nowrap;">Download Again</button>`;
    container.appendChild(div);
  });
}

function redownloadGame(filename) {
  fetch(filename).then(r => r.blob()).then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
  }).catch(() => showNotification('Download failed!', 'error'));
}

// ============================================
// NAVIGATION
// ============================================
function showPage(pageId) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  const targetPage = document.getElementById(pageId);
  if (targetPage) targetPage.classList.add('active');
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  const navLink = document.querySelector(`.nav a[data-page="${pageId}"]`);
  if (navLink) navLink.classList.add('active');

  pagesVisited.add(pageId);
  if (pagesVisited.size >= 5) unlockBadge('explorer');

  if (pageId === 'settings') unlockBadge('first-setting');
  if (pageId === 'shop') { unlockBadge('window-shopper'); renderShop(); }
  if (pageId === 'achievements') checkDailyReward();
  if (pageId === 'chat' && window.myName) setupChat();
  else if (pageId === 'profile') loadProfile();
}

window.addEventListener('load', () => {
  loadSettings(); loadUserData(); loadBadges();
  document.querySelectorAll('.nav a').forEach((link) => {
    const pageId = link.dataset.page;
    link.addEventListener('click', function(event) { event.preventDefault(); event.stopPropagation(); if (pageId) showPage(pageId); });
  });
  const hash = window.location.hash.substring(1);
  if (hash && document.getElementById(hash)) showPage(hash);
  else showPage('home');
  const storedUsername = localStorage.getItem("nexus_user");
  if (storedUsername) {
    db.ref("users/" + storedUsername).once("value", (snap) => {
      if (snap.exists()) { window.myName = storedUsername; updateProfileDisplay(); loadCoinData(); startCoinEarning(); }
    });
  }
  checkDailyReward(); setInterval(checkDailyReward, 60000);
});

// ============================================
// GAMES DATA
// ============================================
const TOP_GAMES = [
  { id:"roblox", name:"Roblox", url:"https://jeremyryanknight2012.github.io/My-Website/games/roblox.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/roblox.png", category:"adventure" },
  { id:"1v1lol", name:"1v1.LOL", url:"https://jeremyryanknight2012.github.io/My-Website/games/1v1lol.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/1v1lol.png", category:"action" },
  { id:"retrobowl", name:"Retro Bowl", url:"https://jeremyryanknight2012.github.io/My-Website/games/retrobowl.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/retrobowl.png", category:"sports" },
  { id:"ultrakill", name:"Ultrakill", url:"https://jeremyryanknight2012.github.io/My-Website/games/ultrakill.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/ultrakill.png", category:"action" }
];

const ALL_GAMES = [
  { id:"2playerbattle", name:"2 Player Battle", url:"https://turbowarp.org/292728003/embed", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/2playerbattle.png", category:"action" },
  { id:"3dtuning", name:"3D Tuning", url:"https://www.3dtuning.com/en-US/", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/3dtuning.png", category:"puzzle" },
  { id:"10minutestilldawn", name:"10 Minutes Till Dawn", url:"https://jeremyryanknight2012.github.io/My-Website/games/10minutestilldawn.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/10minutestilldawn.png", category:"action" },
  { id:"amongus", name:"Among Us", url:"https://jeremyryanknight2012.github.io/My-Website/games/amongus.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/amongus.png", category:"puzzle" },
  { id:"armedforces", name:"Armed Forces", url:"https://jeremyryanknight2012.github.io/My-Website/games/armedforces.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/armedforces.png", category:"action" },
  { id:"badparenting", name:"Bad Parenting", url:"https://jeremyryanknight2012.github.io/My-Website/games/badparenting.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/badparenting.png", category:"horror" },
  { id:"balatro", name:"Balatro", url:"https://jeremyryanknight2012.github.io/My-Website/games/balatro.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/balatro.png", category:"puzzle" },
  { id:"bankrobbery2", name:"Bank Robbery 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/bankrobbery2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/bankrobbery2.png", category:"action" },
  { id:"baseballbros", name:"Baseball Bros", url:"https://jeremyryanknight2012.github.io/My-Website/games/baseballbros.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/baseballbros.png", category:"sports" },
  { id:"basketbros", name:"Basket Bros", url:"https://jeremyryanknight2012.github.io/My-Website/games/basketbros.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/basketbros.png", category:"sports" },
  { id:"basketrandom", name:"Basket Random", url:"https://jeremyryanknight2012.github.io/My-Website/games/basketrandom.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/basketrandom.png", category:"sports" },
  { id:"bendyandtheinkmachine", name:"Bendy and the Ink Machine", url:"https://jeremyryanknight2012.github.io/My-Website/games/bendy.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/bendy.png", category:"horror" },
  { id:"thebindingofisaac", name:"The Binding of Isaac", url:"https://jeremyryanknight2012.github.io/My-Website/games/bindingofisaac.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/bindingofisaac.png", category:"adventure" },
  { id:"bitlife", name:"Bitlife", url:"https://jeremyryanknight2012.github.io/My-Website/games/bitlife.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/bitlife.png", category:"puzzle" },
  { id:"buckshotroulette", name:"Buckshot Roulette", url:"https://jeremyryanknight2012.github.io/My-Website/games/buckshotroulette.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/buckshotroulette.png", category:"horror" },
  { id:"buildnow", name:"Build Now", url:"https://jeremyryanknight2012.github.io/My-Website/games/buildnow.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/buildnow.png", category:"action" },
  { id:"callofduty", name:"Call of Duty", url:"https://jeremyryanknight2012.github.io/My-Website/games/callofduty.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/callofduty.png", category:"action" },
  { id:"cookieclicker", name:"Cookie Clicker", url:"https://jeremyryanknight2012.github.io/My-Website/games/cookieclicker.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/cookieclicker.png", category:"puzzle" },
  { id:"coreball", name:"Coreball", url:"https://jeremyryanknight2012.github.io/My-Website/games/coreball.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/coreball.png", category:"puzzle" },
  { id:"crossyroad", name:"Crossy Road", url:"https://jeremyryanknight2012.github.io/My-Website/games/crossyroad.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/crossyroad.png", category:"adventure" },
  { id:"cuphead", name:"Cuphead", url:"https://jeremyryanknight2012.github.io/My-Website/games/cuphead.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/cuphead.png", category:"adventure" },
  { id:"cuttherope", name:"Cut the Rope", url:"https://jeremyryanknight2012.github.io/My-Website/games/cuttherope.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/cuttherope.png", category:"puzzle" },
  { id:"doodlejump", name:"Doodle Jump", url:"https://jeremyryanknight2012.github.io/My-Website/games/doodlejump.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/doodlejump.png", category:"adventure" },
  { id:"doom", name:"Doom", url:"https://jeremyryanknight2012.github.io/My-Website/games/doom.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/doom.png", category:"action" },
  { id:"doom2", name:"Doom 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/doom2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/doom2.png", category:"action" },
  { id:"drifthunters", name:"Drift Hunters", url:"https://jeremyryanknight2012.github.io/My-Website/games/drifthunters.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/drifthunters.png", category:"sports" },
  { id:"drivemad", name:"Drive Mad", url:"https://jeremyryanknight2012.github.io/My-Website/games/drivemad.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/drivemad.png", category:"adventure" },
  { id:"endoparasitic", name:"Endoparasitic", url:"https://jeremyryanknight2012.github.io/My-Website/games/endoparasitic.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/endoparasitic.png", category:"horror" },
  { id:"escaperoad", name:"Escape Road", url:"https://jeremyryanknight2012.github.io/My-Website/games/escaperoad.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/escaperoad.png", category:"action" },
  { id:"fallout", name:"Fallout", url:"https://jeremyryanknight2012.github.io/My-Website/games/fallout.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fallout.png", category:"adventure" },
  { id:"flappybird", name:"Flappy Bird", url:"https://jeremyryanknight2012.github.io/My-Website/games/flappybird.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/flappybird.png", category:"adventure" },
  { id:"fnaf1", name:"FNAF 1", url:"https://jeremyryanknight2012.github.io/My-Website/games/fnaf1.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fnaf1.png", category:"horror" },
  { id:"fnaf2", name:"FNAF 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/fnaf2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fnaf2.png", category:"horror" },
  { id:"fnaf3", name:"FNAF 3", url:"https://jeremyryanknight2012.github.io/My-Website/games/fnaf3.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fnaf3.png", category:"horror" },
  { id:"fnaf4", name:"FNAF 4", url:"https://jeremyryanknight2012.github.io/My-Website/games/fnaf4.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fnaf4.png", category:"horror" },
  { id:"fnaf4halloween", name:"FNAF 4 Halloween Edition", url:"https://jeremyryanknight2012.github.io/My-Website/games/fnaf4halloween.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fnaf4halloween.png", category:"horror" },
  { id:"footballbros", name:"Football Bros", url:"https://jeremyryanknight2012.github.io/My-Website/games/footballbros.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/footballbros.png", category:"sports" },
  { id:"fruitninja", name:"Fruit Ninja", url:"https://jeremyryanknight2012.github.io/My-Website/games/fruitninja.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/fruitninja.png", category:"action" },
  { id:"geometrydash", name:"Geometry Dash", url:"https://jeremyryanknight2012.github.io/My-Website/games/geometrydash.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/geometrydash.png", category:"adventure" },
  { id:"granny1", name:"Granny", url:"https://jeremyryanknight2012.github.io/My-Website/games/granny1.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/granny1.png", category:"horror" },
  { id:"granny2", name:"Granny Chapter 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/granny2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/granny2.png", category:"horror" },
  { id:"granny3", name:"Granny Chapter 3", url:"https://jeremyryanknight2012.github.io/My-Website/games/granny3.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/granny3.png", category:"horror" },
  { id:"halflife", name:"Half-Life", url:"https://jeremyryanknight2012.github.io/My-Website/games/halflife.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/halflife.png", category:"action" },
  { id:"hollowknight", name:"Hollow Knight", url:"https://jeremyryanknight2012.github.io/My-Website/games/hollowknight.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/hollowknight.png", category:"adventure" },
  { id:"jetpackjoyride", name:"Jetpack Joyride", url:"https://jeremyryanknight2012.github.io/My-Website/games/jetpackjoyride.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/jetpackjoyride.png", category:"adventure" },
  { id:"johnnytrigger", name:"Johnny Trigger", url:"https://jeremyryanknight2012.github.io/My-Website/games/johnnytrigger.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/johnnytrigger.png", category:"action" },
  { id:"kindergarten", name:"Kindergarten", url:"https://jeremyryanknight2012.github.io/My-Website/games/kindergarten.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/kindergarten.png", category:"adventure" },
  { id:"kindergarten2", name:"Kindergarten 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/kindergarten2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/kindergarten2.png", category:"adventure" },
  { id:"kindergarten3", name:"Kindergarten 3", url:"https://jeremyryanknight2012.github.io/My-Website/games/kindergarten3.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/kindergarten3.png", category:"adventure" },
  { id:"learntofly", name:"Learn to Fly", url:"https://jeremyryanknight2012.github.io/My-Website/games/learntofly.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/learntofly.png", category:"adventure" },
  { id:"melonplayground", name:"Melon Playground", url:"https://jeremyryanknight2012.github.io/My-Website/games/melonplayground.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/melonplayground.png", category:"puzzle" },
  { id:"minecraft", name:"Minecraft", url:"https://jeremyryanknight2012.github.io/My-Website/games/minecraft.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/minecraft.png", category:"adventure" },
  { id:"nazizombies", name:"Nazi Zombies", url:"https://jeremyryanknight2012.github.io/My-Website/games/nazizombies.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/nazizombies.png", category:"action" },
  { id:"papersplease", name:"Papers Please", url:"https://jeremyryanknight2012.github.io/My-Website/games/papersplease.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/papersplease.png", category:"puzzle" },
  { id:"pixelgun3d", name:"Pixel Gun 3D", url:"https://jeremyryanknight2012.github.io/My-Website/games/pixelgun.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/pixelgun.png", category:"action" },
  { id:"poppyplaytime", name:"Poppy Playtime", url:"https://jeremyryanknight2012.github.io/My-Website/games/poppyplaytime.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/poppyplaytime.png", category:"horror" },
  { id:"freddyfazbearspizzeriasimulator", name:"Freddy Fazbear's Pizzeria Simulator", url:"https://jeremyryanknight2012.github.io/My-Website/games/pizzeriasimulator.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/pizzeriasimulator.png", category:"horror" },
  { id:"plantsvszombies", name:"Plants vs Zombies", url:"https://jeremyryanknight2012.github.io/My-Website/games/plantsvszombies.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/plantsvszombies.png", category:"puzzle" },
  { id:"plantsvszombies2", name:"Plants vs Zombies 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/plantsvszombies2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/plantsvszombies2.png", category:"puzzle" },
  { id:"pokemon", name:"Pokemon", url:"https://jeremyryanknight2012.github.io/My-Website/games/pokemon.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/pokemon.png", category:"adventure" },
  { id:"raft", name:"Raft", url:"https://jeremyryanknight2012.github.io/My-Website/games/raft.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/raft.png", category:"adventure" },
  { id:"ragdollarchers", name:"Ragdoll Archers", url:"https://jeremyryanknight2012.github.io/My-Website/games/ragdollarchers.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/ragdollarchers.png", category:"action" },
  { id:"retrobowlcollege", name:"Retro Bowl College", url:"https://jeremyryanknight2012.github.io/My-Website/games/retrobowlcollege.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/retrobowlcollege.png", category:"sports" },
  { id:"schoolboyrunaway", name:"Schoolboy Runaway", url:"https://jeremyryanknight2012.github.io/My-Website/games/schoolboyrunaway.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/schoolboyrunaway.png", category:"adventure" },
  { id:"sisterlocation", name:"Sister Location", url:"https://jeremyryanknight2012.github.io/My-Website/games/sisterlocation.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/sisterlocation.png", category:"horror" },
  { id:"slenderman", name:"Slenderman", url:"https://jeremyryanknight2012.github.io/My-Website/games/slenderman.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/slenderman.png", category:"horror" },
  { id:"slimerancher", name:"Slime Rancher", url:"https://jeremyryanknight2012.github.io/My-Website/games/slimerancher.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/slimerancher.png", category:"adventure" },
  { id:"slitherio", name:"Slither.io", url:"https://jeremyryanknight2012.github.io/My-Website/games/slitherio.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/slitherio.png", category:"action" },
  { id:"slope", name:"Slope", url:"https://jeremyryanknight2012.github.io/My-Website/games/slope.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/slope.png", category:"adventure" },
  { id:"smashkarts", name:"Smash Karts", url:"https://jeremyryanknight2012.github.io/My-Website/games/smashkarts.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/smashkarts.png", category:"action" },
  { id:"snowrider", name:"Snow Rider", url:"https://jeremyryanknight2012.github.io/My-Website/games/snowrider.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/snowrider.png", category:"adventure" },
  { id:"superhot", name:"SUPERHOT", url:"https://jeremyryanknight2012.github.io/My-Website/games/superhot.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/superhot.png", category:"action" },
  { id:"supermario64", name:"Super Mario 64", url:"https://jeremyryanknight2012.github.io/My-Website/games/supermario64.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/supermario64.png", category:"adventure" },
  { id:"supermariobros", name:"Super Mario Bros", url:"https://jeremyryanknight2012.github.io/My-Website/games/supermariobros.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/supermariobros.png", category:"adventure" },
  { id:"survivalrace", name:"Survival Race", url:"https://jeremyryanknight2012.github.io/My-Website/games/survivalrace.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/survivalrace.png", category:"sports" },
  { id:"templerun2", name:"Temple Run 2", url:"https://jeremyryanknight2012.github.io/My-Website/games/templerun2.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/templerun2.png", category:"adventure" },
  { id:"terraria", name:"Terraria", url:"https://jeremyryanknight2012.github.io/Terraria", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/terraria.png", category:"adventure" },
  { id:"theyarecoming", name:"They are Coming", url:"https://jeremyryanknight2012.github.io/My-Website/games/theyarecoming.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/theyarecoming.png", category:"action" },
  { id:"tinyfishing", name:"Tiny Fishing", url:"https://jeremyryanknight2012.github.io/My-Website/games/tinyfishing.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/tinyfishing.png", category:"adventure" },
  { id:"tombofthemask", name:"Tomb of the Mask", url:"https://jeremyryanknight2012.github.io/My-Website/games/tombofthemask.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/tombofthemask.png", category:"adventure" },
  { id:"ultimatecustomnight", name:"Ultimate Custom Night", url:"https://jeremyryanknight2012.github.io/My-Website/games/ultimatecustomnight.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/ultimatecustomnight.png", category:"horror" },
  { id:"undertale", name:"Undertale", url:"https://jeremyryanknight2012.github.io/My-Website/games/undertale.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/undertale.png", category:"adventure" }
];

let currentCategory = 'all';

// ============================================
// MOVIES DATA
// ============================================
const TOP_MOVIES = [
  { id:"thesimpsonsmovie", name:"The Simpsons Movie", url:"https://jeremyryanknight2012.github.io/My-Website/movies/simpsonsmovie.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/simpsonsmovie.png" },
  { id:"jurassicpark", name:"Jurassic Park", url:"https://jeremyryanknight2012.github.io/My-Website/movies/jurassicpark.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/jurassicpark.png" }
];
const ALL_MOVIES = [
  { id:"acharliebrownchristmas", name:"A Charlie Brown Christmas", url:"https://jeremyryanknight2012.github.io/My-Website/movies/acharliebrownchristmas.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/acharliebrownchristmas.png" },
  { id:"avengersendgame", name:"Avengers Endgame", url:"https://jeremyryanknight2012.github.io/My-Website/movies/avengersendgame.html", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/avengersendgame.png" }
];

// ============================================
// TV SHOWS DATA
// ============================================
const ALL_TVSHOWS = [
  { name:"Adventure Time", url:"https://drive.google.com/drive/folders/1OwoKydzUQUUp6n-Nh7CCAQXGLfchU8Ta", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/adventuretime.png" },
  { name:"Amazing World of Gumball", url:"https://drive.google.com/drive/folders/1jhdpF65hUXwCRjOZKqquWB4z8L1ZpII7", thumb:"https://jeremyryanknight2012.github.io/My-Website/thumbnails/amazingworldofgumball.png" }
];

// ============================================
// RENDER FUNCTIONS
// ============================================
function renderGames() {
  const topScroller = document.getElementById('topGamesScroller');
  const allScroller = document.getElementById('allGamesScroller');
  function cardHTML(g) {
    const isFavorite = favorites.some(f => f.id === g.id);
    return `<button class="favorite-btn ${isFavorite ? 'active' : ''}" data-fav-id="${g.id}" onclick="event.stopPropagation(); toggleFavorite('${g.id}', '${g.name}', '${g.url}', '${g.thumb}', 'game')">${isFavorite ? 'â­' : 'â˜†'}</button><img class="thumb" src="${g.thumb}" alt="${g.name}"><strong>${g.name}</strong><button class="game-btn" data-url="${g.url}" data-title="${g.name}" data-id="${g.id}" data-thumb="${g.thumb}">Launch</button>`;
  }
  topScroller.innerHTML = '';
  TOP_GAMES.forEach(g => { const d = document.createElement('div'); d.className = 'game'; d.innerHTML = cardHTML(g); topScroller.appendChild(d); });
  allScroller.innerHTML = '';
  const filteredGames = currentCategory === 'all' ? ALL_GAMES : ALL_GAMES.filter(g => g.category === currentCategory);
  filteredGames.forEach(g => { const d = document.createElement('div'); d.className = 'game'; d.innerHTML = cardHTML(g); allScroller.appendChild(d); });
}

function filterGamesByCategory(category) {
  currentCategory = category;
  document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  renderGames();
}

function renderMovies() {
  const topScroller = document.getElementById('topMoviesScroller');
  const allScroller = document.getElementById('allMoviesScroller');
  function cardHTML(m) {
    const isFavorite = favorites.some(f => f.id === m.id);
    return `<button class="favorite-btn ${isFavorite ? 'active' : ''}" data-fav-id="${m.id}" onclick="event.stopPropagation(); toggleFavorite('${m.id}', '${m.name}', '${m.url}', '${m.thumb}', 'movie')">${isFavorite ? 'â­' : 'â˜†'}</button><img class="thumb" src="${m.thumb}"><strong>${m.name}</strong><button class="movie-btn" data-url="${m.url}" data-title="${m.name}" data-id="${m.id}" data-thumb="${m.thumb}">Watch</button>`;
  }
  topScroller.innerHTML = '';
  TOP_MOVIES.forEach(m => { const d = document.createElement('div'); d.className = 'movie'; d.innerHTML = cardHTML(m); topScroller.appendChild(d); });
  allScroller.innerHTML = '';
  ALL_MOVIES.forEach(m => { const d = document.createElement('div'); d.className = 'movie'; d.innerHTML = cardHTML(m); allScroller.appendChild(d); });
}

function renderTVShows() {
  const allScroller = document.getElementById('allTVShowsScroller'); allScroller.innerHTML = '';
  ALL_TVSHOWS.forEach(t => { const d = document.createElement('div'); d.className = 'tvshow'; d.innerHTML = `<img class="thumb" src="${t.thumb}" alt="${t.name}"><strong>${t.name}</strong><button class="tvshow-btn" onclick="location.href='${t.url}'">Watch</button>`; allScroller.appendChild(d); });
}

renderGames(); renderMovies(); renderTVShows();

// ============================================
// SEARCH
// ============================================
let searchUsed = false;
function markSearchUsed() { if (!searchUsed) { searchUsed = true; unlockBadge('searcher'); } }

document.getElementById('games-search').addEventListener('input', (e) => {
  markSearchUsed();
  const term = e.target.value.toLowerCase();
  const filtered = ALL_GAMES.filter(g => g.name.toLowerCase().includes(term) && (currentCategory === 'all' || g.category === currentCategory));
  const allScroller = document.getElementById('allGamesScroller');
  const empty = document.getElementById('gamesEmpty');
  if (filtered.length === 0) { empty.style.display = 'block'; allScroller.innerHTML = ''; }
  else {
    empty.style.display = 'none'; allScroller.innerHTML = '';
    filtered.forEach(g => {
      const isFavorite = favorites.some(f => f.id === g.id);
      const d = document.createElement('div'); d.className = 'game';
      d.innerHTML = `<button class="favorite-btn ${isFavorite ? 'active' : ''}" data-fav-id="${g.id}" onclick="event.stopPropagation(); toggleFavorite('${g.id}', '${g.name}', '${g.url}', '${g.thumb}', 'game')">${isFavorite ? 'â­' : 'â˜†'}</button><img class="thumb" src="${g.thumb}" alt="${g.name}"><strong>${g.name}</strong><button class="game-btn" data-url="${g.url}" data-title="${g.name}" data-id="${g.id}" data-thumb="${g.thumb}">Launch</button>`;
      allScroller.appendChild(d);
    });
  }
});
document.getElementById('games-clear').addEventListener('click', () => { document.getElementById('games-search').value = ''; document.getElementById('gamesEmpty').style.display = 'none'; renderGames(); });

document.getElementById('movies-search').addEventListener('input', (e) => {
  markSearchUsed();
  const v = e.target.value.toLowerCase();
  const f = ALL_MOVIES.filter(m => m.name.toLowerCase().includes(v));
  const empty = document.getElementById('moviesEmpty');
  const allScroller = document.getElementById('allMoviesScroller');
  empty.style.display = f.length ? 'none' : 'block'; allScroller.innerHTML = '';
  f.forEach(m => {
    const isFavorite = favorites.some(fav => fav.id === m.id);
    const d = document.createElement('div'); d.className = 'movie';
    d.innerHTML = `<button class="favorite-btn ${isFavorite ? 'active' : ''}" data-fav-id="${m.id}" onclick="event.stopPropagation(); toggleFavorite('${m.id}', '${m.name}', '${m.url}', '${m.thumb}', 'movie')">${isFavorite ? 'â­' : 'â˜†'}</button><img class="thumb" src="${m.thumb}"><strong>${m.name}</strong><button class="movie-btn" data-url="${m.url}" data-title="${m.name}" data-id="${m.id}" data-thumb="${m.thumb}">Watch</button>`;
    allScroller.appendChild(d);
  });
});
document.getElementById('movies-clear').addEventListener('click', () => { document.getElementById('movies-search').value = ''; document.getElementById('moviesEmpty').style.display = 'none'; renderMovies(); });

document.getElementById('tvshows-search').addEventListener('input', (e) => {
  markSearchUsed();
  const v = e.target.value.toLowerCase();
  const f = ALL_TVSHOWS.filter(t => t.name.toLowerCase().includes(v));
  const allScroller = document.getElementById('allTVShowsScroller'); allScroller.innerHTML = '';
  f.forEach(t => { const d = document.createElement('div'); d.className = 'tvshow'; d.innerHTML = `<img class="thumb" src="${t.thumb}" alt="${t.name}"><strong>${t.name}</strong><button class="tvshow-btn" onclick="location.href='${t.url}'">Watch</button>`; allScroller.appendChild(d); });
});
document.getElementById('tvshows-clear').addEventListener('click', () => { document.getElementById('tvshows-search').value = ''; renderTVShows(); });

// ============================================
// PLAYER OVERLAY
// ============================================
const player = document.getElementById('player');
const frame = document.getElementById('playerFrame');
const nameEl = document.getElementById('playerName');
const closeBtn = document.getElementById('closeBtn');

document.addEventListener('click', e => {
  const btn = e.target.closest('.game-btn, .movie-btn'); if (!btn) return;
  const id = btn.dataset.id || btn.dataset.title;
  const title = btn.dataset.title;
  const url = btn.dataset.url;
  const thumb = btn.dataset.thumb;
  const type = btn.classList.contains('game-btn') ? 'game' : 'movie';
  if (id && title && url && thumb) addToRecentlyPlayed(id, title, url, thumb, type);
  if (type === 'movie') unlockBadge('movie-starter');
  checkSpeedRunner();
  nameEl.textContent = title; frame.src = url; player.classList.add('open');
  try { if (!document.fullscreenElement) player.requestFullscreen(); } catch {}
});

closeBtn.onclick = () => { player.classList.remove('open'); frame.src = ''; if (document.fullscreenElement) document.exitFullscreen(); };

// ============================================
// UTILITY
// ============================================
function openWaterGame() {
  const win = window.open("about:blank");
  const url = "https://cgxlyxnlynjpbmdiywnrc3rhcnrtewvkdwnhdglvbml0d2fzc29sawdtd2.familyguy.in/signin.html";
  const iframe = win.document.createElement("iframe");
  iframe.style.width = "100%"; iframe.style.height = "100%"; iframe.style.border = "none"; iframe.src = url;
  win.document.body.style.margin = "0"; win.document.body.appendChild(iframe);
}

function openUnblockedGoogle() {
  const win = window.open("about:blank");
  const url = "https://browse.familyguy.in";
  const iframe = win.document.createElement("iframe");
  iframe.style.width = "100%"; iframe.style.height = "100%"; iframe.style.border = "none"; iframe.src = url;
  win.document.body.style.margin = "0"; win.document.body.appendChild(iframe);
}

// ============================================
// REQUEST FORM
// ============================================
document.getElementById('requestForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const statusEl = document.getElementById('status');
  statusEl.className = ''; statusEl.textContent = 'Sending...';
  emailjs.sendForm('service_4caoubc', 'template_67jfhnb', this).then(
    function() { statusEl.textContent = 'âœ… Your request has been sent!'; statusEl.classList.add('status-ok'); document.getElementById('requestForm').reset(); },
    function(error) { statusEl.textContent = 'âŒ Failed to send request. Please try again.'; statusEl.classList.add('status-bad'); console.error('EmailJS Error:', error); }
  );
});

// ============================================
// PASSWORD AUTHENTICATION SYSTEM
// ============================================
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function setAuthStatus(msg, type) {
  const el = document.getElementById('auth-status-msg');
  if (!el) return;
  el.textContent = msg;
  el.className = 'auth-status-msg show ' + (type || 'error');
}
function clearAuthStatus() {
  const el = document.getElementById('auth-status-msg');
  if (el) { el.textContent = ''; el.className = 'auth-status-msg'; }
}

async function loginUser() {
  clearAuthStatus();
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username) { setAuthStatus('âš ï¸ Please enter a username.', 'warning'); return; }
  if (!password) { setAuthStatus('ðŸ”’ Password required.', 'error'); return; }
  db.ref("users/" + username).once("value", async (snap) => {
    if (!snap.exists()) { setAuthStatus('âŒ User not found. Please register first.', 'error'); return; }
    const userData = snap.val();
    if (!userData.passwordHash) { setAuthStatus('âŒ This account has no password set.', 'error'); return; }
    const enteredHash = await hashPassword(password);
    if (enteredHash !== userData.passwordHash) { setAuthStatus('âŒ Incorrect password. Try again.', 'error'); return; }
    window.myName = username;
    localStorage.setItem("nexus_user", username);
    setAuthStatus('âœ… Logged in as ' + username + '!', 'success');
    document.getElementById('login-password').value = '';
    updateProfileDisplay(); loadCoinData(); startCoinEarning();
    showNotification('Logged in successfully!', 'success');
  });
}

async function registerUser() {
  clearAuthStatus();
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username) { setAuthStatus('âš ï¸ Please enter a username.', 'warning'); return; }
  if (!password) { setAuthStatus('ðŸ”’ Password required to register.', 'error'); return; }
  if (password.length < 4) { setAuthStatus('âš ï¸ Password must be at least 4 characters.', 'warning'); return; }
  db.ref("users/" + username).once("value", async (snap) => {
    if (snap.exists()) {
      setAuthStatus('âŒ Username already taken. Pick another.', 'error');
    } else {
      const passwordHash = await hashPassword(password);
      await db.ref("users/" + username).set({
        status: "online", pfp: "https://via.placeholder.com/120", customStatus: "",
        friends: {}, coins: 0, purchasedGames: [], passwordHash: passwordHash
      });
      window.myName = username;
      localStorage.setItem("nexus_user", username);
      setAuthStatus('âœ… Account created! Welcome, ' + username + '!', 'success');
      document.getElementById('login-password').value = '';
      updateProfileDisplay(); loadCoinData(); startCoinEarning();
      showNotification('Registered successfully!', 'success');
      unlockBadge('welcome');
    }
  });
}

// ============================================
// REDESIGNED CHAT LOGIC
// ============================================
function switchRailTab(tab) {
  currentRailTab = tab;
  document.querySelectorAll('.rail-icon').forEach(el => el.classList.remove('active'));
  const railEl = document.getElementById('rail-' + tab);
  if (railEl) railEl.classList.add('active');
  // Show/hide sections based on tab
  const friendList = document.getElementById('friend-list');
  const groupList = document.getElementById('group-list');
  const groupsLabel = document.getElementById('groups-label');
  if (tab === 'friends') {
    friendList.style.display = 'block';
    groupList.style.display = 'none';
    groupsLabel.style.display = 'none';
  } else if (tab === 'groups') {
    friendList.style.display = 'none';
    groupList.style.display = 'block';
    groupsLabel.style.display = 'flex';
  } else {
    friendList.style.display = 'block';
    groupList.style.display = 'block';
    groupsLabel.style.display = 'flex';
  }
}

function setupChat() {
  if (!window.myName) { showNotification('Please login via Profile page first.', 'warning'); return; }
  db.ref("users/" + window.myName + "/status").set("online");
  db.ref("users/" + window.myName + "/status").onDisconnect().set("offline");
  listenFriends(); listenGroups();
  updateRightPanel(null);
}

function listenFriends() {
  db.ref("users/" + window.myName + "/friends").on("value", (snap) => {
    const list = document.getElementById("friend-list"); list.innerHTML = ""; myFriends = [];
    snap.forEach((f) => {
      const fName = f.key; myFriends.push(fName);
      const entryId = `friend-entry-${fName}`;
      const div = document.createElement("div");
      div.className = "chat-entry"; div.id = entryId;
      div.innerHTML = `
        <div class="chat-entry-avatar" id="fl-av-${fName}" style="cursor:pointer;" onclick="event.stopPropagation(); viewUserProfile('${fName}', 'chat')">
          ${fName.charAt(0).toUpperCase()}
          <div class="online-dot" id="fl-dot-${fName}" style="display:none;"></div>
        </div>
        <div class="chat-entry-info" onclick="openChat('${fName}', document.getElementById('${entryId}'), 'private')">
          <div class="chat-entry-name">${fName}</div>
          <div class="chat-entry-preview" id="fl-preview-${fName}">Click to chat</div>
        </div>
        <div class="chat-entry-meta">
          <button class="chat-remove-btn" onclick="event.stopPropagation(); unfriend('${fName}')" title="Remove">âœ–</button>
        </div>
      `;
      list.appendChild(div);

      // Watch pfp
      db.ref("users/" + fName + "/pfp").on("value", (s) => {
        const av = document.getElementById(`fl-av-${fName}`);
        if (av && s.val() && s.val() !== 'https://via.placeholder.com/120') {
          av.innerHTML = `<img src="${s.val()}" alt="${fName}"><div class="online-dot" id="fl-dot-${fName}" style="display:none;"></div>`;
        }
      });
      // Watch online status
      db.ref("users/" + fName + "/status").on("value", (s) => {
        const dot = document.getElementById(`fl-dot-${fName}`);
        if (dot) dot.style.display = s.val() === 'online' ? 'block' : 'none';
      });
    });
    if (myFriends.length >= 5) unlockBadge('social-butterfly');
    updateRightPanel(activeChat);
  });
}

function listenGroups() {
  db.ref("groups").on("value", (snap) => {
    const box = document.getElementById("group-list"); box.innerHTML = "";
    const groupsLabel = document.getElementById('groups-label');
    let hasGroups = false;
    snap.forEach((g) => {
      const data = g.val();
      if (data.members && data.members[window.myName]) {
        hasGroups = true;
        const gid = g.key;
        const entryId = `group-entry-${gid}`;
        const div = document.createElement("div"); div.className = "chat-entry"; div.id = entryId;
        div.innerHTML = `
          <div class="chat-entry-avatar" style="background:rgba(147,51,234,0.3);color:#a855f7;">G</div>
          <div class="chat-entry-info" onclick="openChat('${gid}', document.getElementById('${entryId}'), 'group')">
            <div class="chat-entry-name">${data.name}</div>
            <div class="chat-entry-preview">Group chat</div>
          </div>
          <div class="chat-entry-meta">
            <button class="chat-remove-btn" onclick="event.stopPropagation(); leaveGroup('${gid}')" title="Leave">âœ–</button>
          </div>
        `;
        box.appendChild(div);
      }
    });
    if (groupsLabel) groupsLabel.style.display = hasGroups ? 'flex' : 'none';
  });
}

function openChat(id, el, type) {
  activeChat = id; chatType = type;

  // Update entries highlight
  document.querySelectorAll(".chat-entry").forEach((i) => i.classList.remove("active-chat"));
  if (el) el.classList.add("active-chat");

  // Show active view
  document.getElementById('chat-empty-state').style.display = 'none';
  const av = document.getElementById('chat-active-view');
  av.style.display = 'flex';

  const topbarAv = document.getElementById('topbar-avatar');
  const topbarName = document.getElementById('active-chat-user');
  const topbarStatus = document.getElementById('topbar-status');
  const groupBtn = document.getElementById("make-group-btn");
  const manageBtn = document.getElementById("manage-group-btn");

  groupBtn.style.display = type === "private" ? "block" : "none";
  manageBtn.style.display = "none";

  if (type === "global") {
    topbarAv.innerHTML = '#';
    topbarName.textContent = 'Public Channel';
    topbarStatus.innerHTML = '<span class="status-dot"></span> Live';
    document.getElementById("rail-public").classList.add('active');
  } else if (type === "private") {
    topbarName.textContent = id;
    topbarAv.innerHTML = id.charAt(0).toUpperCase();
    topbarStatus.innerHTML = '<span class="status-dot"></span> Loading...';
    db.ref("users/" + id + "/pfp").on("value", (snap) => {
      if (snap.val() && snap.val() !== 'https://via.placeholder.com/120') {
        topbarAv.innerHTML = `<img src="${snap.val()}" alt="${id}">`;
      }
    });
    db.ref("users/" + id + "/status").on("value", (snap) => {
      const isOnline = snap.val() === 'online';
      topbarStatus.innerHTML = `<span class="status-dot" style="background:${isOnline ? 'var(--online)' : 'var(--offline)'}"></span> ${isOnline ? 'Online' : 'Offline'}`;
    });
  } else if (type === "group") {
    db.ref("groups/" + id).on("value", (snap) => {
      const data = snap.val(); if (!data) return;
      topbarName.textContent = 'Group: ' + data.name;
      topbarAv.innerHTML = 'G';
      topbarStatus.innerHTML = '<span class="status-dot" style="background:rgba(147,51,234,0.8)"></span> Group Chat';
      if (data.owner === window.myName) manageBtn.style.display = "block";
    });
  }

  // Load messages
  const chatId = type === "global" ? "GLOBAL_CHAT" : type === "group" ? id : [window.myName, id].sort().join("_");
  db.ref("messages/" + chatId).off();
  const msgRef = db.ref("messages/" + chatId).limitToLast(50);
  const box = document.getElementById("chat-msgs"); box.innerHTML = "";

  // Date separator for today
  const sep = document.createElement('div');
  sep.className = 'msg-date-sep';
  sep.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  box.appendChild(sep);

  msgRef.on("child_added", (snap) => {
    const d = snap.val();
    renderMessage(box, snap.key, d);
    box.scrollTop = box.scrollHeight;
  });

  updateRightPanel(id);
  document.getElementById('chat-input').focus();
}

function renderMessage(box, key, d) {
  const isMe = d.sender === window.myName;
  const div = document.createElement("div");
  div.className = `nova-msg ${isMe ? 'is-me' : ''}`;

  const time = d.timestamp ? new Date(d.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

  if (!isMe) {
    div.innerHTML = `
      <div class="nova-msg-avatar" id="msg-av-${key}" onclick="viewUserProfile('${d.sender}', 'chat')">
        ${d.sender ? d.sender.charAt(0).toUpperCase() : '?'}
      </div>
      <div class="nova-msg-body">
        <div class="nova-msg-header">
          <span class="nova-msg-sender" onclick="viewUserProfile('${d.sender}', 'chat')">${d.sender}</span>
          <span class="nova-msg-time">${time}</span>
        </div>
        <div class="nova-msg-bubble">${escapeHtml(d.text)}</div>
      </div>
    `;
    db.ref("users/" + d.sender + "/pfp").once("value", (pSnap) => {
      const av = document.getElementById(`msg-av-${key}`);
      if (av && pSnap.val() && pSnap.val() !== 'https://via.placeholder.com/120') {
        av.innerHTML = `<img src="${pSnap.val()}" alt="${d.sender}">`;
      }
    });
  } else {
    const seen = d.seen && Object.keys(d.seen).length > 1;
    div.innerHTML = `
      <div class="nova-msg-body">
        <div class="nova-msg-header">
          <span class="nova-msg-time">${time}</span>
          <span class="nova-msg-sender">You</span>
        </div>
        <div class="nova-msg-bubble">${escapeHtml(d.text)}</div>
        <div class="nova-msg-status">${seen ? 'âœ“âœ“ Seen' : 'âœ“ Sent'}</div>
      </div>
      <div class="nova-msg-avatar" style="cursor:default;">
        ${window.myName ? window.myName.charAt(0).toUpperCase() : 'Y'}
      </div>
    `;
  }
  box.appendChild(div);
}

function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return (text || '').replace(/[&<>"']/g, m => map[m]);
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
}

function autoResizeInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function sendMsg() {
  const inp = document.getElementById("chat-input");
  const text = inp.value.trim();
  if (!activeChat || !text) return;
  if (!window.myName) { showNotification('Please login first!', 'warning'); return; }
  inp.value = ''; inp.style.height = 'auto';

  const chatId = chatType === "global" ? "GLOBAL_CHAT" : chatType === "group" ? activeChat : [window.myName, activeChat].sort().join("_");
  db.ref("messages/" + chatId).push({
    sender: window.myName, text, timestamp: Date.now(),
    seen: { [window.myName]: true }
  });

  unlockBadge('first-message');
  chatMessageCount++;
  localStorage.setItem(CHAT_COUNT_KEY, chatMessageCount.toString());
  if (chatMessageCount >= 10) unlockBadge('chat-active');
}

function updateRightPanel(chatId) {
  const panel = document.getElementById('right-panel-body'); if (!panel) return;
  if (!chatId || chatId === null) {
    panel.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;margin-top:24px;">Select a chat to see info</div>';
    return;
  }
  // Render friend list as members
  if (chatType === 'private' && chatId) {
    panel.innerHTML = `
      <div class="right-panel-stat"><span class="stat-label">Chatting with</span><span class="stat-value">${chatId}</span></div>
      <div class="right-panel-stat" id="rp-status-stat"><span class="stat-label">Status</span><span class="stat-value">â€”</span></div>
      <div style="margin-top:16px;">
        <div class="sidebar-section-label" style="padding:0 0 8px 0;">Actions</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <button class="btn" style="width:100%;" onclick="sendFriendRequestToUser()">+ Add Friend</button>
          <button class="btn" style="width:100%;" onclick="viewUserProfile('${chatId}', 'chat')">View Profile</button>
          <button class="btn" style="width:100%;background:rgba(255,68,68,0.15);border-color:rgba(255,68,68,0.4);" onclick="unfriend('${chatId}')">Remove Friend</button>
        </div>
      </div>
    `;
    db.ref("users/" + chatId + "/status").on("value", (s) => {
      const stat = document.getElementById('rp-status-stat');
      if (stat) {
        const isOnline = s.val() === 'online';
        stat.innerHTML = `<span class="stat-label">Status</span><span class="stat-value" style="color:${isOnline ? 'var(--online)' : 'var(--muted)'}">${isOnline ? 'Online' : 'Offline'}</span>`;
      }
    });
  } else if (chatType === 'global') {
    panel.innerHTML = `
      <div class="right-panel-stat"><span class="stat-label">Channel</span><span class="stat-value"># Public</span></div>
      <div style="margin-top:16px;">
        <div class="sidebar-section-label" style="padding:0 0 8px 0;">Online Friends</div>
        <div id="rp-online-friends"></div>
      </div>
    `;
    const onlineBox = document.getElementById('rp-online-friends');
    if (onlineBox) {
      myFriends.forEach(f => {
        const mc = document.createElement('div'); mc.className = 'member-card';
        mc.innerHTML = `<div class="member-avatar">${f.charAt(0).toUpperCase()}</div><div><div class="member-name">${f}</div><div class="member-status" id="rp-st-${f}">Checking...</div></div>`;
        onlineBox.appendChild(mc);
        db.ref("users/" + f + "/status").on("value", (s) => {
          const el = document.getElementById(`rp-st-${f}`);
          if (el) el.textContent = s.val() === 'online' ? 'ðŸŸ¢ Online' : 'âš« Offline';
        });
      });
    }
  } else {
    panel.innerHTML = `<div class="right-panel-stat"><span class="stat-label">Group Chat</span><span class="stat-value">Active</span></div>`;
  }
}

function createGroup() {
  const gn = prompt("Enter Group Name:");
  if (!gn) return;
  const gid = "group_" + Date.now();
  db.ref("groups/" + gid).set({ name: gn, owner: window.myName, members: { [window.myName]: true, [activeChat]: true } });
  showNotification('Group created!', 'success');
}

function changeChatBG() {
  const url = prompt("Enter Background Image URL:");
  if (url) document.getElementById("chat-pane").style.background = `url('${url}') center/cover`;
}

function viewProfileFromChat() {
  if (chatType === 'private' && activeChat) viewUserProfile(activeChat, 'chat');
  else if (chatType === 'global') showNotification('This is the public channel', 'warning');
  else if (chatType === 'group') showNotification('Group profiles coming soon!', 'warning');
}

function filterFriends() {
  const search = document.getElementById("friend-search").value.toLowerCase();
  document.querySelectorAll("#friend-list .chat-entry").forEach((el) => {
    el.style.display = el.textContent.toLowerCase().includes(search) ? "flex" : "none";
  });
}

function addFriend() {
  const f = prompt("Enter username:");
  if (f && f !== window.myName) {
    db.ref("requests/" + f.toLowerCase() + "/" + window.myName).set(true);
    showNotification('Friend request sent!', 'success');
  }
}

function unfriend(name) {
  if (!confirm(`Remove ${name} from friends?`)) return;
  db.ref("users/" + window.myName + "/friends/" + name).remove();
  db.ref("users/" + name + "/friends/" + window.myName).remove();
  if (activeChat === name) {
    activeChat = null; chatType = "none";
    document.getElementById('chat-empty-state').style.display = 'flex';
    document.getElementById('chat-active-view').style.display = 'none';
  }
}

function leaveGroup(groupId) {
  if (!confirm("Leave this group?")) return;
  db.ref("groups/" + groupId + "/members/" + window.myName).remove();
  if (activeChat === groupId) {
    activeChat = null; chatType = "none";
    document.getElementById('chat-empty-state').style.display = 'flex';
    document.getElementById('chat-active-view').style.display = 'none';
  }
}

// ============================================
// USER PROFILE VIEWING
// ============================================
function viewUserProfile(username, fromPage) {
  if (!username) return;
  viewedUserName = username; previousPage = fromPage || 'chat';
  db.ref("users/" + username).once("value", (snap) => {
    if (!snap.exists()) { showNotification('User not found', 'error'); return; }
    const userData = snap.val();
    document.getElementById('user-profile-username').textContent = username;
    document.getElementById('user-profile-status').textContent = userData.status === 'online' ? 'Online' : 'Offline';
    document.getElementById('user-profile-pic').src = userData.pfp || 'https://via.placeholder.com/120';
    document.getElementById('user-profile-custom-status').textContent = userData.customStatus || '';
    showPage('user-profile');
  });
}

function goBackFromUserProfile() { showPage(previousPage || 'chat'); }

function sendFriendRequestToUser() {
  if (!window.myName) { showNotification('Please login first', 'warning'); return; }
  if (!viewedUserName) return;
  db.ref("requests/" + viewedUserName + "/" + window.myName).set(true);
  showNotification(`Friend request sent to ${viewedUserName}!`, 'success');
}

function messageUser() {
  if (!window.myName) { showNotification('Please login first', 'warning'); return; }
  if (!viewedUserName) return;
  showPage('chat');
  setTimeout(() => {
    let found = false;
    document.querySelectorAll('#friend-list .chat-entry').forEach(item => {
      if (item.textContent.includes(viewedUserName)) { item.click(); found = true; }
    });
    if (!found) showNotification('You need to be friends to send messages!', 'warning');
  }, 500);
}

// ============================================
// PROFILE
// ============================================
function logoutUser() {
  if (window.myName) db.ref("users/" + window.myName + "/status").set("offline");
  stopCoinEarning(); window.myName = null; localStorage.removeItem("nexus_user");
  novaCoins = 0; purchasedGames = []; updateCoinDisplay(); updateProfileDisplay();
  clearAuthStatus(); showNotification('Logged out', 'success');
}

function updateProfileDisplay() {
  if (window.myName) {
    document.getElementById('profile-username').textContent = window.myName;
    document.getElementById('profile-status').textContent = 'Online';
    db.ref("users/" + window.myName + "/pfp").on("value", (snap) => { document.getElementById('profile-pic').src = snap.val() || "https://via.placeholder.com/120"; });
    db.ref("users/" + window.myName + "/customStatus").on("value", (snap) => { document.getElementById('status-input').placeholder = snap.val() || "What's on your mind?"; });
  } else {
    document.getElementById('profile-username').textContent = 'Guest';
    document.getElementById('profile-status').textContent = 'Offline';
    document.getElementById('profile-pic').src = 'https://via.placeholder.com/120';
  }
}

function uploadProfilePic(event) {
  if (!window.myName) { showNotification('Please login first', 'warning'); return; }
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;
    db.ref("users/" + window.myName + "/pfp").set(base64);
    document.getElementById('profile-pic').src = base64;
    showNotification('Profile picture updated!', 'success');
    unlockBadge('profile-editor');
  };
  reader.readAsDataURL(file);
}

function loadProfile() {
  if (!window.myName) return;
  db.ref("requests/" + window.myName).on("value", (snap) => {
    const requestsList = document.getElementById('requests-list'); requestsList.innerHTML = '';
    if (!snap.exists() || snap.numChildren() === 0) { requestsList.innerHTML = '<p class="empty">No pending requests</p>'; return; }
    snap.forEach((req) => {
      const requester = req.key;
      const div = document.createElement('div'); div.className = 'request-item';
      div.innerHTML = `<div class="request-user" style="cursor:pointer;" onclick="viewUserProfile('${requester}', 'profile')"><img class="avatar-circle" src="https://via.placeholder.com/34" id="req-pfp-${requester}"><span>${requester}</span></div><div class="request-actions"><button class="accept-btn" onclick="event.stopPropagation(); acceptRequest('${requester}')">Accept</button><button class="decline-btn" onclick="event.stopPropagation(); declineRequest('${requester}')">Decline</button></div>`;
      requestsList.appendChild(div);
      db.ref("users/" + requester + "/pfp").once("value", (pSnap) => { const img = document.getElementById(`req-pfp-${requester}`); if (img && pSnap.val()) img.src = pSnap.val(); });
    });
  });
}

function acceptRequest(requester) {
  db.ref("users/" + window.myName + "/friends/" + requester).set(true);
  db.ref("users/" + requester + "/friends/" + window.myName).set(true);
  db.ref("requests/" + window.myName + "/" + requester).remove();
  showNotification(`You are now friends with ${requester}!`, 'success');
  unlockBadge('first-friend');
}
function declineRequest(requester) {
  db.ref("requests/" + window.myName + "/" + requester).remove();
  showNotification('Request declined', 'success');
}
</script>
</body>
</html>
